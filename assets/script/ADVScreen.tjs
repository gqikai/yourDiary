/*
	ADVŠÇ—ƒNƒ‰ƒX
*/

//ƒ^ƒOƒnƒ“ƒhƒ‰‚Ì•Ô’l
var taghandler_end = 0;				//ƒ^ƒO‚Ìæ“¾‚ğI—¹‚µ‚ÄAˆ—‚ğ‹g—¢‹g—¢‚É–ß‚·
var taghandler_getcontinue = -1;	//‘±‚¯‚Äƒ^ƒO‚ğæ“¾‚·‚é

var UPDATE_CG		= 0x01;
var UPDATE_BUSTUP	= 0x02;
var UPDATE_CUTIN	= 0x03;

//ƒJƒƒ‰
var camera_fix  = 0;	//ŒÅ’è
var camera_auto = 1;	//©“®’Ç”ö

//Šî–{‹——£
var BG_RANGE_MAX = 128;

class ADVScreen extends Layer, InputNotifyBase, SelectItemNotifyBase, SceneBase{
	var _scenario = "";
	var _scene = "";	//ƒV[ƒ“ƒ^ƒCƒgƒ‹
	var _name = "";
	var _mess = "";
	var _voice = "";
	var _pan = "";
	//ƒVƒiƒŠƒI§Œä
	var _scCtrl;
	var _orderList;
	var _orderIndex;
	var _end = false;	//‚±‚Ìƒtƒ‰ƒO‚ª^‚È‚ç‚ÎAƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“‚ªI—¹‚µ‚½“_‚Åclose()‚·‚é
	//ƒx[ƒXƒŒƒCƒ„
	var _baseOrder;
	//ƒIƒuƒWƒFƒNƒgŠÇ—
	var _objList;
	//ƒƒbƒZ[ƒWŠÇ—
	var _msg;
	var _msgX, _msgY;	//•\¦ˆÊ’uAŠî–{ˆÊ’u‚©‚ç‚Ì‘Š‘ÎÀ•W
	//ƒJƒbƒgƒCƒ“
	var _cutin;
	var _cutinParam = %[file:"", pos:""];

	//ƒpƒ‰ƒ[ƒ^(ƒtƒ‰ƒO)ŠÇ—
	var _param, _paramPrev;

	//ƒƒOŠÇ—
	var _logName, _logMess, _logVoice, _logParam;

	//‰æ–ÊXVŠÇ—
	var _update;		//

	var _sprTrans;		//ƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“—pƒŒƒCƒ„
	var _eyeCatch;		//ƒAƒCƒLƒƒƒbƒ`—pƒŒƒCƒ„

	var _sprFlash;		//ƒtƒ‰ƒbƒVƒ…—pƒŒƒCƒ„
	var _flashLeave;	//ƒtƒ‰ƒbƒVƒ…@•œ‹AŠÔ .beginActivation(_flashLeave);

	//ƒƒbƒZ[ƒWƒtƒŒ[ƒ€‚Ì”ñ•\¦
	//true‚É‚·‚é‚ÆŸ‚Ìhitret‚ª‚­‚é‚Ü‚Å“ü—Í‚ÅÄ•\¦‚Å‚«‚È‚¢B
	var _advHide;
	//“ú•tEƒ‹[ƒv•\¦‚Ì§Œä
	//w’è‚ª‚ ‚é‚Ü‚Å•\¦‚Å‚«‚È‚¢B
	var _advLoopHide, _advDateHide;

	//ƒJƒƒ‰
	var _fCamera_move;		//
	var _camera_mode;		//ƒJƒƒ‰ƒ‚[ƒh
	var _camera_pos;		//ƒJƒƒ‰ˆÊ’u
							//x : ‰¡²
							//y : c²
							//z : ƒJƒƒ‰‹——£
	var _camera_move;		//ƒJƒƒ‰‚ÌˆÚ“®ƒ‰ƒCƒ“
	var _camera_move_start;	//ƒJƒƒ‰‚ÌˆÚ“®ŠJnŠÔ
	var _camera_move_time;	//ƒJƒƒ‰‚ÌˆÚ“®ŠÔ

	//ƒAƒNƒVƒ‡ƒ“
	var _fAction;
	var _actionTimeKeeper;
	var _actionList;
	var _actionWaitTarget;

	//ƒXƒLƒbƒv
	var _requestStopSkip;	//Ÿ‚ÌHitret‚ÉƒXƒLƒbƒv‚ğ’â~‚³‚¹‚éB

	//ƒI[ƒg
	var _autoTimer;
	var _autoState;
	var _fPlayVoice;		//‰¹º‚ğw’è‚ª‚ ‚Á‚½i@talk‚É‰¹ºƒtƒ@ƒCƒ‹‚Ìw’è‚ª‚ ‚Á‚½j
	var _fPlayedVoice;		//ÀÛ‚É‰¹º‚ªÄ¶‚³‚ê‚½‚©

	//‘I‘ğˆ
	var _startSelect;
	var _select;
	var _selectBase;
	var _selectBtn;
	var ret_select;		//‘I‘ğ‚³‚ê‚½”Ô†ã‚©‚ç‡
	var ret_select_str;	//‘I‘ğ‚³‚ê‚½•¶š—ñ
	var _logSelect;		//‘I‘ğˆ‚Å‘I‚ñ‚¾Œ‹‰Ê‚ğ‹L‰¯ ƒZ[ƒu•œ‹A—p

	var _hitretWaitUntil;
	var _hitretState;	//hitret, startSelectó‘Ô(false: true:hitret‘Ò‚¿’†)
						//true‚Å‚È‚¢‚Æ‚«‚Í‚pƒZ[ƒu‚Å‚«‚È‚¢B
	var _hitretNum;		//hitret‰ñ”(startSelect‚àƒJƒEƒ“ƒg) ƒZ[ƒu•œ‹A—p
	var _quickSave;		//‚±‚Ìhitret‚ÅƒNƒCƒbƒNƒZ[ƒu‚µ‚½B

	var _fFont;				//Ÿ‚Ì1ƒƒbƒZ[ƒW‚ÉŒÀ‚èƒtƒHƒ“ƒg‚ğ•ÏX‚·‚é
	var _fontElm;
	var _fIgnoreKinsoku;	//Ÿ‚Ì1ƒƒbƒZ[ƒW‚ÉŒÀ‚è‹Ö‘¥ˆ—‚ğ–³‹‚·‚é

	var _partMess;			//Ÿ‚ÌƒƒbƒZ[ƒW‚Ìw’è•¶š‚ÌF‚ğ•ÏX‚·‚é
	var _ruby;				//Ÿ‚ÌƒƒbƒZ[ƒW‚Ìw’è•¶š‚Éƒ‹ƒr‚ğ•\¦‚·‚é

	var _face;				//ƒtƒFƒCƒX‚Ì”CˆÓ•ÏX

	var _fBustupAutoPositioning;	//ƒoƒXƒgƒAƒbƒv‚Ì©“®ˆÊ’u’²®
	var _fBustupRelateFlip;			//ƒoƒXƒgƒAƒbƒv‚ÌˆÊ’uŠÖŒW‚Ì”½“]

	var _fMovie;			//ƒ€[ƒr[Ä¶’†

	var _fRecollect;		//‰ñ‘zƒ‚[ƒhƒtƒ‰ƒO

	var _shift;

	//ƒ[ƒhˆ——p
	var _fLoad;
	var _hitretCnt;
	var _selectCnt;
	var _saveData;		//ƒ[ƒh‚µ‚½ƒZ[ƒuƒf[ƒ^‚Ì•Û

	//ƒfƒoƒbƒO—p
	var _strSearch;			//ƒT[ƒ`ƒXƒLƒbƒv

	var AUTOSTATE_MESSAGE_END = 0x01;
	var AUTOSTATE_VOICE_END = 0x02;
	var AUTOSTATE_TRANSITION_END = 0x04;
	var AUTOSTATE_ALL_END = AUTOSTATE_MESSAGE_END | 
							AUTOSTATE_VOICE_END | 
							AUTOSTATE_TRANSITION_END;

	var CUTIN_X = WINDOW_WIDTH / 2;
	var CUTIN_Y = WINDOW_HEIGHT / 2 - 50;

	function ADVScreen(win, order=0, msgOrder=10, fRecollect=false){
		Layer(win, win.baseLayer);

		_scCtrl = new ScController(getHandlers());

		_orderList = new Array();
		_orderIndex = 0;

		_fRecollect = fRecollect;

		_objList = new Array();

		_baseOrder = order;

		hasImage = false;
		setSize(WINDOW_WIDTH, WINDOW_HEIGHT);
		absolute = _baseOrder;
		hitType = htMask;
		hitThreshold = 0;
		visible = true;

		_sprTrans = new Sprite(window, window.baseLayer);
		with(_sprTrans){
			.setImageSize(WINDOW_WIDTH, WINDOW_HEIGHT);
			.setSizeToImageSize();
			.absolute = _baseOrder + 1;
			.setTransitionCompleteCall(transitionComplete);
			.setActionCall(action);
		}

		_eyeCatch = null;

		var id;
		id = addADVObject("”wŒi");
		with(_objList[id]){
			.kind = ADVOBJ_CG;
			._spr.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);
			.setWorldPos(0, 0, BG_RANGE_MAX);
			.setBasePos(WINDOW_CENTER_X, WINDOW_CENTER_Y);
			.setCenter(WINDOW_CENTER_X, WINDOW_CENTER_Y);
			._spr.fillRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT, GetDefineColorA("black"));
			.absolute = 5;
			.visible = true;
			.onPaint();
		}

		//ƒƒbƒZ[ƒWƒGƒŠƒAì¬
		_msg = new MessageFrame(window, window.baseLayer, this);
		_msg.absolute = msgOrder;
		_msgX = 0;
		_msgY = 0;

		_param = new Parameter(PARAMETER_MAX);
		_paramPrev = new Parameter(PARAMETER_MAX);

		_logName = [];
		_logMess = [];
		_logVoice = [];
		_logParam = [];

		_advHide = true;

		//ƒJƒƒ‰‰Šúİ’è
		_fCamera_move = false;
		_camera_mode = camera_auto;
		_camera_pos = new Point(0, 0, -BG_RANGE_MAX);
		_camera_move = new D3Linear();
		_camera_move_start = 0;
		_camera_move_time = 500;

		//ƒAƒNƒVƒ‡ƒ“
		_fAction = false;
		_actionTimeKeeper = new TimeKeeper();
		_actionTimeKeeper.start();
		_actionList = new ActionList(this);
		_actionWaitTarget = null;

		_sprFlash = void;

		//ƒXƒLƒbƒv
		_requestStopSkip = false;
		//ƒI[ƒg
		_autoTimer = new Timer(onAutoCallback, "");
		_autoTimer.interval = CONFIG.autoSpeed + 1;
		_autoState = 0;
		_fPlayVoice = false;
		_fPlayedVoice = false;

		_select = [];
		_selectBtn = [];
		_selectBase = new SelectItemGroupSprite(win, this);
		with(_selectBase){
			.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);
			.absolute = ADVLAYER_SELECT;
			.hitType = htMask;
			.hitThreshold = 0;
			.opacity = 0;
		}
		_logSelect = [];

		_hitretState = false;
		_hitretNum = 0;

		_update = 0;

		_msg.skip = _msg.auto = false;

		_fFont = false;
		_fontElm = new Dictionary();
		_fIgnoreKinsoku = false;
		resetFontElm();

		_partMess = [];
		_ruby = [];

		_face = "";

		_fBustupAutoPositioning = true;
		_fBustupRelateFlip = false;

		_strSearch = "";

		_fLoad = false;
		_saveData = null;

		_fMovie = false;

		window.addInputNotify(this);
	}

	function finalize(){
		@if(__DEBUGMODE__)
			win.caption = global.GAME_CAPTION;
		@endif
		@if(__DEBUGMODE__)
			debug.applyFlagToDebug();
		@endif

		window.removeInputNotify(this);

		endSelect();

		if(IsStaffRoll()) StaffRollDelete();

		//ƒEƒBƒ“ƒhƒEŠÖŒW
		//ConfirmDelete();
		ConfigDelete();
		LoadSaveDelete();
		HistoryDelete();

		System.removeContinuousHandler(onActionCallback);

		if(_eyeCatch) invalidate _eyeCatch;
		invalidate _sprFlash;
		invalidate _fontElm;
		InvalidateArray(_selectBtn);
		invalidate _selectBtn;
		invalidate _selectBase;
		invalidate _select;
		invalidate _camera_pos;
		invalidate _camera_move;
		invalidate _param;
		invalidate _paramPrev;
		invalidate _orderList;
		invalidate _msg;
		invalidate _sprTrans;
		invalidate _scCtrl;
		InvalidateArray(_objList);
		invalidate _objList;
		invalidate _logName;
		invalidate _logMess;
		invalidate _logVoice;
		invalidate _logParam;
		invalidate _actionList;
		invalidate _actionTimeKeeper;

		global.Layer.finalize();
	}

	function who(){return "ADVScreen";}

	function start(name, label=""){
		if(!_fLoad){
			ParameterInit(_param);
			_logName.clear();
			_logMess.clear();
			_logVoice.clear();
			_logParam.clear();
		}

		change(name, label);
	}

	function debugStart(name, label=""){
		if(!_fLoad){
			_logName.clear();
			_logMess.clear();
			_logVoice.clear();
			_logParam.clear();
		}

		if(_startSelect) endSelect();
		cutin(%[hide:1]);

		change(name, label);
	}

	function trigger(trig){
		_scCtrl.trigger(trig);
	}

	function rClick(){
		//ƒ€[ƒr[‚ªÄ¶‚³‚ê‚Ä‚¢‚½‚çƒ€[ƒr[‚ğƒLƒƒƒ“ƒZƒ‹
		if(IsPlayMovie() && _scCtrl.isTrigger("rclick")) onStopMovie();

		_scCtrl.trigger("rclick");
	}

	function click(){
		//ƒEƒBƒ“ƒhƒEÁ‹’†‚È‚çƒNƒŠƒbƒN‚È‚µ
		//¦‰º‚ÉˆÚ“®‚³‚¹‚Ü‚µ‚½B
		//if(!isShow()) return;

		//ƒJƒƒ‰ˆÚ“®‘Ò‹@’†‚©‚ÂAƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹—LŒø‚Ì‚Í
		//ƒJƒƒ‰ˆÚ“®‚ğŠ®—¹‚³‚¹‚éB
		if(_scCtrl.isTrigger("movecamera_end") && _scCtrl.isTrigger("click")){
			flushMoveCamera();
		}

		//ƒAƒNƒVƒ‡ƒ“‘Ò‚¿’†‚©‚ÂAƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹—LŒø‚Ì‚Í
		//ƒAƒNƒVƒ‡ƒ“‚ğŠ®—¹‚³‚¹‚éB
		if(_scCtrl.isTrigger("action_end") && _scCtrl.isTrigger("click")){
			flushAction(_actionWaitTarget);
			_actionWaitTarget = null;
		}

		//ƒtƒ‰ƒbƒVƒ…‘Ò‚¿’†AƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹—LŒø‚Ì‚Í
		//ƒtƒ‰ƒbƒVƒ…‚ğŠ®—¹‚³‚¹‚éB
		if(_scCtrl.isTrigger("flash_end") && _scCtrl.isTrigger("click")){
			if(_sprFlash !== void){
				if(_sprFlash.isActivation()) _sprFlash.flushActivation();
			}
		}

		//ƒEƒBƒ“ƒhƒEÁ‹’†‚È‚çƒNƒŠƒbƒN‚È‚µ
		if(!isShow()) return;

		if(_msg.isPending()){
		//ƒƒbƒZ[ƒWo—Í’†
			_msg.flush();
			return;
		}

		if(_scCtrl.trigger("click")){
		//ƒNƒŠƒbƒNƒgƒŠƒK[‚ª”­¶‚µ‚½
			_msg.hideBlink();

//			if(_sprFlash !== void){
//				if(_sprFlash.isActivation()) _sprFlash.flushActivation();
//			}

			//hitret’†‚ÉƒNƒŠƒbƒN‚³‚ê‚½B
			//‚±‚êˆÈ~‚Í_hitretState‚ªtrue‚É‚È‚é‚Ü‚Å‚pƒZ[ƒu‚ª—}§‚³‚ê‚éB
			if(_hitretState){
				_hitretState = false;
				if(_face != "") _face = "";
			}

			if(CONFIG.voiceStopOnClick){
			//‰¹ºÄ¶’†‚ÉƒNƒŠƒbƒN‚ª”­¶‚µ‚½ê‡‚Í’â~‚·‚é
				_fPlayVoice = false;
				if(VOICE.isPlay()) StopVoice();
			}
		}

		//ƒI[ƒgƒ^ƒCƒ}[‚ğ‰ğœ‚µ‚Ä‚¨‚­
		stopAutoTimer();
	}

	//ƒƒbƒZ[ƒWo—Í‚ªŠ®—¹‚µ‚½
	function onCompleteOutput(){
		checkAutoEvent(AUTOSTATE_MESSAGE_END);

		if(isSkip()){
		//ƒXƒLƒbƒv’†‚È‚çƒNƒŠƒbƒN
			click();
		}else if(isAuto()){
		//ƒI[ƒg’†‚È‚çƒNƒŠƒbƒNƒ`ƒFƒbƒN
			if(checkAutoEvent()){ startAutoTimer(); }
		}
	}

	function startAutoTimer(){
		_autoTimer.interval = CONFIG.autoSpeed + 1;
		_autoTimer.enabled = true;
	}
	function stopAutoTimer(){
		if(!_autoTimer.enabled) return;
		_autoTimer.enabled = false;
	}

	//ƒƒbƒZ[ƒWo—ÍŠ®—¹A‰¹ºÄ¶Š®—¹Aƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“Š®—¹
	//ª‚ª‘S‚ÄŠ®—¹‚µ‚½AƒƒbƒZ[ƒW‚ği‚ß‚é€”õ‚ªo—ˆ‚½‚±‚Æ‚É‚È‚éB
	function checkAutoEvent(state=0){
		_autoState |= state;
		if(_autoState == AUTOSTATE_ALL_END) return isAuto();
		return false;
	}

	function updateEnding(){
		_scCtrl.trigger("update");
	}

	//ƒI[ƒ_[ƒŠƒXƒg
	function addOrderList(elm){
		var index = _orderList.count;
		_orderList[index] = new Dictionary();
		(Dictionary.assign incontextof _orderList[index])(elm);
	}
	function clearOrderList(){
		_orderList.clear();
		_orderIndex = 0;
	}
	function processOrder(list=[], elm=%[]){
		for(var i=0;i<list.count;i++){
			//time‚ğupdate‚Åw’è‚³‚ê‚½’l‚Æ“¯‚¶‚É‚·‚é‚©‚Ç‚¤‚©EEE
			//if(elm.time !== void) list[i].time = elm.time;

			if(elm.flush !== void){
				if(elm.flush == 1) list[i].time = 0;
			}

			//ƒ^ƒO–¼‚ğ•]‰¿‚µ‚Äƒtƒ@ƒ“ƒNƒVƒ‡ƒ“‚ğ“¾‚é
			//var func = Scripts.eval("ADVScreen."+list[i].tagname);
			//func(list[i]);

			switch(list[i].tagname){
			case "cg":
				cg(list[i]);
				break;
			case "char":
				char(list[i]);
				break;
			case "clearchar":
				clearChar(list[i]);
				break;
			case "cutin":
				cutin(list[i]);
				break;
			case "movecamera":
				moveCamera(list[i]);
				break;
			case "move":
				move(list[i]);
				break;
			case "action":
				asyncAction(list[i]);
				break;
			case "stopaction":
				stopAsyncAction(list[i]);
				break;
			case "tone":
				tone(list[i]);
				break;
			case "focus":
				focus(list[i]);
				break;
			case "update":
				update(list[i]);
				break;
			}
		}
		list.clear();
	}
	function separateOrder(srcList, preList, postList){
		for(var i=0;i<srcList.count;i++){
			switch(srcList[i].tagname){
			case "action" :
			case "focus" :
			case "tone" :
				var index = postList.count;
				postList[index] = %[];
				(Dictionary.assign incontextof postList[index])(srcList[i]);
				break;
			default:
				var index = preList.count;
				preList[index] = %[];
				(Dictionary.assign incontextof preList[index])(srcList[i]);
				break;
			}
		}
	}

	//ADVObjectŠÇ—
	function addADVObject(id){
	//ƒIƒuƒWƒFƒNƒgƒŠƒXƒg‚Ì’Ç‰Á
		if(_objList.count > 0){
			for(var i=_objList.count-1;i>=0;i--){
				if(_objList[i].id == id){
					return i;
				}
			}
		}

		var i = _objList.count;
		_objList[i] = new ADVObject(window, this);
		_objList[i].id = id;
		return i;
	}
	function removeADVObject(id){
	//ƒIƒuƒWƒFƒNƒgƒŠƒXƒg‚Ìíœ
		if(typeof id == "String"){
			for(var i=_objList.count-1;i>=0;i--){
				if(_objList[i].id == id){
					_objList[i].visible = false;
					if(_objList[i].isActivation()) _objList[i].stopActivation();
					if(_objList[i].isTransition()) _objList[i].stopTransition();
					invalidate _objList[i];
					_objList.erase(i);
					return 0;
				}
			}
			return -1;
		}else if(typeof id == "Integer"){
			for(var i=_objList.count-1;i>=0;i--){
				if(_objList[i].kind == id){
					_objList[i].visible = false;
					if(_objList[i].isActivation()) _objList[i].stopActivation();
					if(_objList[i].isTransition()) _objList[i].stopTransition();
					invalidate _objList[i];
					_objList.erase(i);
				}
			}
			return 0;
		}
	}
	function countADVObjCg(){
		cleaningADVObjectList();

		var cnt = 0;
		for(var i=_objList.count-1;i>=0;i--){
			if((_objList[i].kind == ADVOBJ_CG) &&
			   (_objList[i].destroy == ADVOBJ_DESTROY_NONE))
				cnt++;
		}
		return cnt;
	}
	function countADVObjBustup(){
		cleaningADVObjectList();

		var cnt = 0;
		for(var i=_objList.count-1;i>=0;i--){
			if((_objList[i].kind == ADVOBJ_BUSTUP) &&
			   (_objList[i].destroy == ADVOBJ_DESTROY_NONE))
				cnt++;
		}
		return cnt;
	}
	//id‚©‚çƒCƒ“ƒfƒbƒNƒX‚ğæ“¾‚·‚é
	function getADVObjectIndex(id, fAll=false){
		cleaningADVObjectList();

		for(var i=0;i<_objList.count;i++){
			if(fAll){
				if(_objList[i].id == id){
					return i;
				}
			}else{
			//Á–Å—\’è‚ÌƒIƒuƒWƒFƒNƒg‚Í–³‹‚·‚é
				if((_objList[i].id == id)  &&
				   (_objList[i].destroy == ADVOBJ_DESTROY_NONE)){
					return i;
				}
			}
		}
		return -1;
	}
	//id‚©‚çƒIƒuƒWƒFƒNƒg‚ğæ“¾‚·‚é
	function getADVObjectObject(id, fAll=false){
		cleaningADVObjectList();

		for(var i=0;i<_objList.count;i++){
			if(fAll){
				if(_objList[i].id == id){
					return _objList[i];
				}
			}else{
			//Á–Å—\’è‚ÌƒIƒuƒWƒFƒNƒg‚Í–³‹‚·‚é
				if((_objList[i].id == id)  &&
				   (_objList[i].destroy == ADVOBJ_DESTROY_NONE)){
					return _objList[i];
				}
			}
		}
		return -1;
	}
	function cleaningADVObjectList(){
		for(var i=_objList.count-1;i>=0;i--){
			if(_objList[i].destroy == ADVOBJ_DESTROY_STANDBY){
				invalidate _objList[i];
				_objList.erase(i);
			}
		}
	}
	function sortADVObjectBustupRelate(){
	//ƒŠƒXƒg“à‚ÌƒoƒXƒgƒAƒbƒv‚ğrelate‚Ì¸‡‚É•À‚Ñ‘Ö‚¦‚é
		//ADVOBJ_CG‚ğæ“ª‚ÖŠñ‚¹‚é
		var i, j;
		for(i=0;i<_objList.count-1;i++){
			if(_objList[i].kind == ADVOBJ_BUSTUP){
				for(j=i+1;j<_objList.count;j++){
					if(!_fBustupRelateFlip){
						if((_objList[j].kind == ADVOBJ_BUSTUP) &&
						   (_objList[i].relate > _objList[j].relate)){
							_objList[i] <-> _objList[j];
						}
					}else{
					//ˆÊ’uŠÖŒW”½“]
						if((_objList[j].kind == ADVOBJ_BUSTUP) &&
						   (_objList[i].relate < _objList[j].relate)){
							_objList[i] <-> _objList[j];
						}
					}
				}
			}
		}
	}

	//ƒJƒƒ‰‘€ì
	function cameraMode(mode=camera_auto){
		_camera_mode = mode;
	}
	function moveCamera(elm=%[]){
		//ƒJƒƒ‰‚ªƒAƒNƒVƒ‡ƒ“’†‚È‚ç~‚ß‚é
		if(_actionList.isAction(_camera_pos))
			_actionList.stopAction(_camera_pos);

//		var scale = 2.0 * (1.0 + ((_camera_pos.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
		var scale = 2.0;

		cleaningADVObjectList();

		var pos;
		if(elm.pos === void)
			pos = new Point();
		else
			pos = PointStrToNum(elm.pos);
		if(elm.x !== void) pos.x = elm.x;
		if(elm.y !== void) pos.y = elm.y;
		if(elm.z !== void) pos.z = elm.z;

		pos.z -= BG_RANGE_MAX;

		if(elm.id !== void){
			var id = getADVObjectIndex(elm.id);
			if(id != -1){
				pos.x = _objList[id].getWorldPos().x / scale;
			}
		}
		pos.x *= scale;
		pos.y *= scale;

		var accel;
		if(elm.accel !== void)
			accel = elm.accel;
		else
			accel = 2;

		var time = 500;
		if(elm.time !== void)
			time = int(elm.time);
		if(isSkip())
			time = 0;
		if(CONFIG.screenEffect == 0)
			time = 0;

		//XVŠÔ‚ğ‰‰o‘¬“xİ’è‚Å•â³
		time = ReviceEffectSpeed(time);

		if(time == 0){
			@if(__DEBUGMODE__)
				debug.setCameraPos(int(pos.x/scale), int(pos.y/scale), pos.z+BG_RANGE_MAX);
			@endif

			_camera_pos.set(pos);

			putCameraViewObject(pos);
		}else{
			startAction();

			_fCamera_move = true;
			_camera_move.set(_camera_pos, pos, accel);
			_camera_move_start = _actionTimeKeeper.now();
			_camera_move_time = time;
		}
	}
	function putCameraViewObject(camera){
	//ƒJƒƒ‰‚É‡‚í‚¹‚ÄƒIƒuƒWƒFƒNƒg‚ğ”z’u
		for(var i=0;i<_objList.count;i++){
			with(_objList[i]){
				var pos = worldToScreen(camera, .getWorldPos());
				if(.left != int(-pos.x) || .top != int(-pos.y))
					.setPos(-pos.x, -pos.y);
				if(.zoomx != pos.z)
					.zoom = pos.z;
			}
		}
	}

	function onCameraCallback(now, fPutObj=true){
		var t;
		if(_camera_move_time == 0.0){
			t = 1.0;
		}else{
			//Œo‰ßŠÔ‚©‚çi’»‚ğŒv‘ª
			t = (now - _camera_move_start) / real(_camera_move_time);
			if(t > 1.0) t = 1.0;
		}

		var pt = new Point();
		if(_fCamera_move){
			pt.set(_camera_move.pt(t));
		}else{
			pt.set(_camera_pos);
		}

		if(t >= 1.0){
			flushMoveCamera();
		}else{
			if(fPutObj) putCameraViewObject(pt);
			_camera_pos.set(pt);
		}

		@if(__DEBUGMODE__)
//			var scale = 2.0 * (1.0 + ((pt.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
			var scale = 2.0;
			debug.setCameraPos(pt.x/scale, pt.y/scale, pt.z + BG_RANGE_MAX);
		@endif
	}
	function flushMoveCamera(fPutObj=true){
		var pt = new Point();
		if(_fCamera_move){
			pt.set(_camera_move.pt(1.0));
		}else{
			pt.set(_camera_pos);
		}
		if(fPutObj) putCameraViewObject(pt);
		_camera_pos.set(pt);
		_fCamera_move = false;

		_scCtrl.trigger("movecamera_end");

		@if(__DEBUGMODE__)
//			var scale = 2.0 * (1.0 + ((pt.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
			var scale = 2.0;
			debug.setCameraPos(pt.x/scale, pt.y/scale);
		@endif
	}

	//ƒ[ƒ‹ƒh¨ƒXƒNƒŠ[ƒ“•ÏŠ·
	function worldToScreen(camera, wPos){
		var tempPos = new Point();

		var z = wPos.z - camera.z;
		tempPos.x = ((camera.x-wPos.x)*BG_RANGE_MAX) / z;
		tempPos.y = ((camera.y-wPos.y)*BG_RANGE_MAX) / z;
		tempPos.z = 100 * (wPos.z+BG_RANGE_MAX) / (wPos.z-camera.z);	//Z‚ÍŠg‘å—¦‚Å—˜—p

		return tempPos;
	}
	//ƒXƒNƒŠ[ƒ“¨ƒ[ƒ‹ƒh•ÏŠ·
	function screenToWorld(camera, pos){
		var tempPos = new Point();

		var z = pos.z-camera.z;
		tempPos.x = camera.x + (pos.x * z) / BG_RANGE_MAX;
		tempPos.y = camera.y + (pos.y * z) / BG_RANGE_MAX;
		tempPos.z = pos.z;

		return tempPos;
	}

	function onActionCallback(now){
		var time = _actionTimeKeeper.now();

		//ƒJƒƒ‰ˆÚ“®
		if(_fCamera_move)
			onCameraCallback(time, false);

		//ƒAƒNƒVƒ‡ƒ“
		if(_actionList.count != 0){
			_actionList.doAction(time);
		}

		//ƒJƒƒ‰‚É‡‚í‚¹‚ÄƒIƒuƒWƒFƒNƒg”z’u
		putCameraViewObject(_camera_pos);

		@if(__DEBUGMODE__)
			debug.setCameraPos(_camera_pos.x, _camera_pos.y, _camera_pos.z+BG_RANGE_MAX);
		@endif

		if(!isActivity()){
			stopAction();
		}
	}

	function startAction(){
		System.addContinuousHandler(onActionCallback);
		_fAction = true;
	}
	function stopAction(){
		System.removeContinuousHandler(onActionCallback);
		_fAction = false;
	}
	function pauseAction(){
		if(!_fAction) return;

		_actionTimeKeeper.pause();
		System.removeContinuousHandler(onActionCallback);
	}
	function restartAction(){
		if(!_fAction) return;

		_actionTimeKeeper.restart();
		System.addContinuousHandler(onActionCallback);
	}
	function isActivity(){
	//Šˆ“®’†‚ÌƒIƒuƒWƒFƒNƒg‚Í‚ ‚é‚©H

		//ƒAƒNƒVƒ‡ƒ“ƒŠƒXƒg‚ª‚PˆÈã‚È‚çŠˆ“®’†
		if(_actionList.count != 0) return true;

		//ƒJƒƒ‰‚ªˆÚ“®’†‚È‚çŠˆ“®’†
		if(_fCamera_move) return true;

		return false;
	}

	//ƒEƒBƒ“ƒhƒEƒNƒ‰ƒX‚©‚ç‚Ì“ü—Í’Ê’m
	function onMouseDown(x, y, button, shift){
		_shift = shift;

//		if(isSkip(true)) skip(false);	//ƒXƒLƒbƒv‰ğœ

		if(button == mbLeft){
			if(!_msg.isShow() && _advHide == false){
				show(300);
			}else{
				click();
			}
		}else if(button == mbRight){
			//ƒƒbƒZ[ƒWƒtƒŒ[ƒ€Á‹
			if(isAuto() || isSkip(true)){
				skip(false);	//ƒXƒLƒbƒv‰ğœ
				auto(false);	//ƒI[ƒg‰ğœ
			}else if(_advHide == false){
				if(_msg.isActivation()){
				//ƒtƒF[ƒh’†‚È‚ç‚È‚É‚à‚µ‚È‚¢
				}else if(_msg.isShow() && _hitretState){
					hide(300);
				}else{
					show(300);
				}
			}
			rClick();
		}
	}
	function onMouseWheel(shift, delta, x, y){
		_shift = shift;

		if(delta < 0){
		//ƒƒbƒZ[ƒW‚ği‚ß‚é
			click();
		}else if(delta > 0){
		//—š—ğ•\¦
			callSystemWindow(SYSWIN_HISTORY);
		}
	}
	function onMouseMove(x, y, shift){
	}

	function onKeyDown(key, shift){
		_shift = shift;
		if(key == VK_RETURN ||	//ƒNƒŠƒbƒN
		   key == VK_DOWN ||
		   key == VK_NEXT ||
		   key == VK_SPACE
		){
			click();

		//=======================================
		//ƒVƒ‡[ƒJƒbƒgƒL[
		}else if( key == VK_ESCAPE){	//ƒƒbƒZ[ƒWƒtƒŒ[ƒ€Á‹
			if(isAuto() || isSkip(true)){
				skip(false);	//ƒXƒLƒbƒv‰ğœ
				auto(false);	//ƒI[ƒg‰ğœ
			}else if(_advHide == false){
				if(_msg.isActivation()){
				//ƒtƒF[ƒh’†‚È‚ç‚È‚É‚à‚µ‚È‚¢
				}else if(_msg.isShow() && _hitretState){
					hide(300);
				}else{
					show(300);
				}
			}
			rClick();
		}else if(key == VK_CONTROL){	//ƒƒbƒZ[ƒW‘—‚è
			click();
		//----------------------------------------
		@if(__DEBUGMODE__)
			}else if( key == VK_F10){
			//Œ»İ‚ÌƒVƒiƒŠƒIEs‚ğƒGƒfƒBƒ^[‚ÅŠJ‚­
				var exe = CONFIG.debugEditerPath;
				if(exe == ""){
					var param = %[];
					with(param){
						.title = "ƒeƒLƒXƒgƒGƒfƒBƒ^[‚ğ‘I‘ğ‚µ‚Ä‚­‚¾‚³‚¢";
						.filter = ["ƒGƒfƒBƒ^[(*.exe)|*.exe"];
						.initialDir = "";
					}

					Storages.selectFile(param);
					if(param.name != "")
						CONFIG.debugEditerPath = exe = Storages.getLocalName(param.name);
					else
						CONFIG.debugEditerPath = exe = "C:\\Windows\\notepad.exe";
				}
				exe = exe.toUpperCase();

				var file = Storages.getPlacedPath(_scenario + ".ks");
				var path = Storages.getLocalName(file);
				var param = path;
				if(exe.indexOf("HIDEMARU") != -1)	//GŠÛ‚È‚çsw’è‚à
					param = "/j%d ".sprintf(_scCtrl.curLine) + path;

				if(Storages.isExistentStorage(exe))
					System.shellExecute(exe, param);
				else
					System.shellExecute(path);
			}else if(key == VK_S){
				//ƒAƒNƒVƒ‡ƒ“ƒ^ƒCƒ}‚Ìˆê’â~EÄŠJ
				if(!_actionTimeKeeper.isPause())
					pauseAction();
				else
					restartAction();
			}else if(key == VK_D){
				cleaningADVObjectList();
			}else if(key == VK_A){
		@endif

		//----------------------------------------
		//ƒtƒ@ƒ“ƒNƒVƒ‡ƒ“
		}else if( key == VK_F1){	//Q.save
			quickSave();
		}else if( key == VK_F2){	//Q.load
			quickLoad();
		}else if( key == VK_F3 && !(shift&ssAlt)){	//ƒZ[ƒu
			callSystemWindow(SYSWIN_SAVE);
		}else if( key == VK_F4){	//ƒ[ƒh
			callSystemWindow(SYSWIN_LOAD);
		}else if( key == VK_F5){	//ƒRƒ“ƒtƒBƒO
			callSystemWindow(SYSWIN_CONFIG);
		}else if( key == VK_F6){	//ƒI[ƒg
			auto(!_msg.auto);
		}else if( key == VK_F7){	//ƒXƒLƒbƒv
			skip(!_msg.skip);
		}else if( key == VK_F8 ||	//—š—ğ
		          key == VK_PRIOR ||
		          key == VK_UP){
			callSystemWindow(SYSWIN_HISTORY);
		}else if( key == VK_F9){	//‰¹ºÄ¶
			if(_msg._voice != "" && _hitretState)
				playVoice(_msg._voice, _msg._pan, false);
		}

		if( isSkip(true) && !_startSelect &&
			(key == VK_RETURN || key == VK_SPACE || key == VK_ESCAPE)){
			skip(false);	//ƒXƒLƒbƒv‰ğœ
		}
	}

	function onKeyUp(key, shift){
		_shift = shift;
	}

	//ƒ^ƒCƒ€ƒAƒEƒg’Ê’m
	function onTimeOut(){
		_scCtrl.trigger("timeout");
	}

	function action(ev){
		//ƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“’†‚ÉƒNƒŠƒbƒN‚³‚ê‚½
		if(ev.target == _sprTrans){
			switch(ev.type){
			case "onMouseDown":
				onMouseDown(ev.x, ev.y, ev.button, ev.shift);
				break;
			case "onMouseWheel":
				onMouseWheel(ev.shift, ev.delta, ev.x, ev.y);
				break;
			case "onKeyDown":
				onKeyDown(ev.key, ev.shift);
				break;
			}

		//ƒTƒEƒ“ƒhƒCƒxƒ“ƒg
		}else if(ev.type == "onStatusChanged" && ev.status == "stop"){
			var snd = ev.target;
			if(BGM.indexOfObject(snd) != -1){
				_scCtrl.trigger("bgm_end");
			}else if(SE.indexOfObject(snd) != -1){
				_scCtrl.trigger("se_end");
			}else if(ENVSE.indexOfObject(snd) != -1){
				_scCtrl.trigger("envse_end");				//
				_scCtrl.trigger("envse_end:"+snd.id);		//id‚ğ’Ç‰Á‚µ‚½ƒgƒŠƒK[‚àˆø‚­
			}else if(VOICE.indexOfObject(snd) != -1){
				//“¯‰¹º‚Ìê‡‚ÍÅŒã‚ÉI—¹‚µ‚½‰¹º‚Ì‚İƒgƒŠƒK[‚ğˆø‚­
				if(!VOICE.isPlay()) _scCtrl.trigger("voice_end");

				if(!VOICE.isPlay()){
				//‘S‚Ä‚Ì‰¹º‚ªI—¹‚µ‚½
					if(_fPlayedVoice){
						if(checkAutoEvent(AUTOSTATE_VOICE_END)){ click();}
						_fPlayedVoice = false;
					}
				}

				@if(__DEBUGMODE__)
					//_msg.stopVoice();
				@endif
			}else if(SYSTEMSOUND.indexOfObject(snd) != -1){
				_scCtrl.trigger("system_end");
			}
		}else if(ev.type == "onStatusChanged" && ev.status == "play"){
			var snd = ev.target;
			if(BGM.indexOfObject(snd) != -1){
				_scCtrl.trigger("bgm_play");
			}else if(SE.indexOfObject(snd) != -1){
				_scCtrl.trigger("se_play");
			}else if(ENVSE.indexOfObject(snd) != -1){
				_scCtrl.trigger("envse_play");
			}else if(VOICE.indexOfObject(snd) != -1){
				_scCtrl.trigger("voice_play");
			}else if(SYSTEMSOUND.indexOfObject(snd) != -1){
				_scCtrl.trigger("system_play");
			}
		//ƒ€[ƒr[ƒCƒxƒ“ƒg
		}else if(ev.type == "Movie.onStatusChanged" && ev.status == "play"){
			_scCtrl.trigger("movie_start");
		}else if(ev.type == "Movie.onStatusChanged" && ev.status == "stop"){
			_scCtrl.trigger("movie_end");
			onStopMovie();

		//ƒXƒ^ƒbƒtƒ[ƒ‹I—¹
		}else if(ev.type == "staffroll_end"){
			_scCtrl.trigger("staffroll_end");

		//ƒEƒBƒ“ƒhƒEƒAƒNƒeƒBƒuE”ñƒAƒNƒeƒBƒu
		}else if(ev.type == "onActivate"){
			_shift = 0x0;
			if(System.getKeyState(VK_SHIFT)) _shift |= ssShift;
			if(System.getKeyState(VK_MENU)) _shift |= ssAlt;
			if(System.getKeyState(VK_CONTROL)){
				_shift |= ssCtrl;
				click();
			}
		}else if(ev.type == "onDeactivate"){

		}else if(ev.type == "onCloseQuery"){
		//•Â‚¶‚éƒ{ƒ^ƒ“‚ª‰Ÿ‚³‚ê‚½
			if(isAuto()) auto(false, true);
//			if(isSkip()) skip(false);
			if(isSkip()) _requestStopSkip = true;

			if(!game.enableClose) return;		//•Â‚¶‚éƒ{ƒ^ƒ“—}§

//			if(!_hitretState && !IsPlayMovie() && !IsStaffRoll())
//				_scCtrl.wait(_hitretWaitUntil);
		}
	}

	function onButtonDownL(target){
		if(_startSelect){
			for(var i=0;i<_select.count;i++){
				if((target == _selectBtn[i].btn)){
					ret_select = i+1;
					ret_select_str = _select[i].text;
					_logSelect.add(ret_select);		//ƒƒO‚É‹L˜^
					endSelect();

					//‘I‘ğˆ‚ğƒƒO‚É•Û‘¶
					_logName.add("¡öÑ¡ÔñÏî¡ö");
					_logMess.add("£¯¡º" + ret_select_str + "¡»");
					_logVoice.add("");
					_logParam.add(%[font:%[], pan:""]);

					//‘I‘ğˆ‚ªŒˆ’è‚³‚ê‚½B
					//‚±‚êˆÈ~‚Í_hitretState‚ªtrue‚É‚È‚é‚Ü‚Å‚pƒZ[ƒu‚ª—}§‚³‚ê‚éB
					_hitretState = false;

					//if(CONFIG.lockSkip == 0 && isSkip())
					//	skip(false);
				}
			}
			if(CONFIG.voiceStopOnClick){
			//‰¹ºÄ¶’†‚ÉƒNƒŠƒbƒN‚ª”­¶‚µ‚½ê‡‚Í’â~‚·‚é
				_fPlayVoice = false;
				if(VOICE.isPlay()) StopVoice();
			}
		}
	}
	function onButtonDownR(target){
		onMouseDown(0, 0, mbRight, 0);
	}
	function onButtonEnter(target){
		if(_startSelect){
			for(var i=0;i<_selectBtn.count;i++){
				if(target == _selectBtn[i].btn) blurSelectHint(i);
			}
		}
	}

	//ƒ^ƒOƒnƒ“ƒhƒ‰
	function getHandlers(){
		return %[

		//ƒƒbƒZ[ƒWˆ—Œn
		talk : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			var pan = "";
			if(elm.pan !== void)
				pan = string(elm.pan);
			var voice = "";
			if(elm.voice !== void)
				voice = elm.voice;

			talk(elm.name, voice, pan);

			//ˆÈ~A‰üsƒR[ƒh‚Ìæ“¾‚ğ—LŒø‚É‚·‚éB
			//‰üsƒR[ƒh‚ğæ“¾‚·‚é”ÍˆÍ‚Í@Tal`@Hitret
			_scCtrl.ignoreCR = false;

			return taghandler_end;
		} incontextof this,

		ch : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			ch(elm.text);
			return taghandler_getcontinue;
		} incontextof this,
		r : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			ch("£¯");
			return taghandler_getcontinue;
		} incontextof this,

		font : function(elm){
			_fFont = true;
			_fontElm.face = elm.face;
			if(elm.size !== void)
				_fontElm.size = elm.size;
			else
				_fontElm.size = ADV_FONT_MESS_SIZE;
			if(elm.bold !== void)
				_fontElm.bold = 1;
			else
				_fontElm.bold = 0;
			if(elm.italic !== void)
				_fontElm.italic = 1;
			else
				_fontElm.italic = 0;
			if(elm.color !== void)
				_fontElm.color = GetDefineColor(elm.color) & 0xffffff;
			else
				_fontElm.color = -1;
			if(elm.bkcolor !== void)
				_fontElm.bkcolor = GetDefineColor(elm.bkcolor) & 0xffffff;
			else
				_fontElm.bkcolor = -1;
			if(elm.indent !== void)
				_fontElm.indent = int elm.indent;
			else
				_fontElm.indent = ADV_FONT_MESS_INDENT;

			return taghandler_getcontinue;
		} incontextof this,

		partmess : function(elm){
			_partMess.add(
			%[mess:elm.mess, face:elm.font, size:elm.size, color:elm.color, bkcolor:elm.bkcolor, bold:elm.bold, italic:elm.italic]
			);

			return taghandler_getcontinue;
		} incontextof this,

		ruby : function(elm){
			if(elm.mess === void || elm.read === void) return;

			_ruby.add(%[mess:elm.mess, read:elm.read]);

			return taghandler_getcontinue;
		} incontextof this,

		ignorekinsoku : function(elm){
			_fIgnoreKinsoku = true;
			return taghandler_getcontinue;
		} incontextof this,

		scene : function(elm){
			_scene = elm.text;
			return taghandler_getcontinue;
		} incontextof this,

		hitret : function(elm){
			//ˆÈ~A‰üsƒR[ƒh‚Ìæ“¾‚ğ–³Œø‚É‚·‚éB
			_scCtrl.ignoreCR = true;

			if(_fLoad && _hitretCnt > 0){
			//‚Ü‚¾•œ‹A’n“_‚Ü‚ÅˆÚ“®’†BBB
				if(_fFont) resetFontElm();

				_hitretCnt--;
				return taghandler_getcontinue;
			}

			if(elm.id === void)
				hitret();
			else
				hitret(elm.id);

			_hitretWaitUntil = %[
			click : function(){
			} incontextof this
			];

			_hitretState = false;

			if(isSkip()){
			//Ctrl‰Ÿ‰º’†‚ÍƒVƒiƒŠƒI‚ğ~‚ß‚¸‚Éi‚ß‚éB
				if(_face != "") _face = "";

				return taghandler_getcontinue;
//			}else if(checkAutoClick()){
//				click();
//				return taghandler_end;
			}else{
				_hitretState = true;		//hitret’†

				//ƒVƒiƒŠƒI‚ğ’â~‚µ‚Ä“ü—Í‘Ò‚¿B
				_scCtrl.wait(_hitretWaitUntil);

				var fVoice = VOICE.isPlay();

				if(isAuto() && !fVoice){
					startAutoTimer();
				}

				return taghandler_end;
			}
		} incontextof this,
		hitwait : function(elm){
		//‰¹ºI—¹‘Ò‚¿‚à‰Á‚¦‚½@hitret
			if(_fLoad && _hitretCnt > 0){
			//‚Ü‚¾•œ‹A’n“_‚Ü‚ÅˆÚ“®’†BBB
				if(_fFont) resetFontElm();

				_hitretCnt--;
				return taghandler_getcontinue;
			}

			if(elm.id === void)
				hitret();
			else
				hitret(elm.id);

			_hitretWaitUntil = %[
			click : function(){
			} incontextof this,
			voice_end : function(){
			} incontextof this
			];

			if(isSkip()){
			//Ctrl‰Ÿ‰º’†‚ÍƒVƒiƒŠƒI‚ğ~‚ß‚¸‚Éi‚ß‚éB
				return taghandler_getcontinue;
//			}else if(checkAutoClick()){
//				click();
//				return taghandler_end;
			}else{
				//ƒVƒiƒŠƒI‚ğ’â~‚µ‚Ä“ü—Í‘Ò‚¿B
				_scCtrl.wait(_hitretWaitUntil);

				var fVoice = VOICE.isPlay();

				if(isAuto() && !fVoice){
					startAutoTimer();
				}

				return taghandler_end;
			}
		} incontextof this,

		show : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			show(300);
			if(elm.wait === void){
				return taghandler_getcontinue;
			}else{
				_scCtrl.wait( %[
				show_end : function(){
				} incontextof this
				]);

				return taghandler_end;
			}
		} incontextof this,

		hide : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			hide(300, true);
			if(elm.wait === void){
				return taghandler_getcontinue;
			}else{
				_scCtrl.wait( %[
				hide_end : function(){
				} incontextof this
				]);

				return taghandler_end;
			}
		} incontextof this,

		movewindow : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			var x, y;
			x = elm.x !== void ? int elm.x : 0;
			y = elm.y !== void ? int elm.y : 0;
			moveWindow(x, y);

			return taghandler_getcontinue;
		} incontextof this,


		//‰æ–Ê•\¦Œn
		cg : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			elm.file = elm.file.toUpperCase();
			addOrderList(elm);
			_update |= UPDATE_CG;

			return taghandler_getcontinue;
		} incontextof this,

		char : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			elm.file = elm.file.toUpperCase();
			addOrderList(elm);
			_update |= UPDATE_BUSTUP;

			return taghandler_getcontinue;
		} incontextof this,

		clearchar : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			_update |= UPDATE_BUSTUP;

			return taghandler_getcontinue;
		} incontextof this,

		autoposition : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			_fBustupAutoPositioning = true;

			return taghandler_getcontinue;
		} incontextof this,

		charrelate : function(elm){
			_fBustupRelateFlip = elm.flip!==void?true:false;
			_update |= UPDATE_CG;

			return taghandler_getcontinue;
		} incontextof this,

		update : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(elm.time === void) elm.time = 500;

			var ret = taghandler_getcontinue;
			if(isAuto() && _update & UPDATE_CG){
			//ƒI[ƒgƒ‚[ƒh’†‚Ì‘S‰æ–ÊXV‚ÍXVI—¹‚ğ‘Ò‚Â
				_scCtrl.wait(
				%[
				click : function(){
				} incontextof this,
				transition_end : function(){
				} incontextof this
				]
				);
				ret = taghandler_end;
			}

			update(elm);

			return ret;
		} incontextof this,

		waitupdate : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isTransition()){
				if(elm.hitcancel === void){
					_scCtrl.wait(
					%[
					click : function(){
					} incontextof this,
					transition_end : function(){
					} incontextof this
					]
					);
				}else{
				//ƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹–³Œø
					_scCtrl.wait(
					%[
					transition_end : function(){
					} incontextof this
					]
					);
				}

				return taghandler_end;
			}else{
				return taghandler_getcontinue;
			}
		} incontextof this,

		//ƒJƒƒ‰‘€ì
		cameraauto : function(elm){		//©“®’Ç”ö
			if(_fLoad) return taghandler_getcontinue;

			cameraMode(camera_auto);
			return taghandler_getcontinue;
		} incontextof this,
		camerafix : function(elm){		//ŒÅ’è
			if(_fLoad) return taghandler_getcontinue;

			cameraMode(camera_fix);
			return taghandler_getcontinue;
		} incontextof this,

		movecamera : function(elm){
		/*
			ƒJƒƒ‰ˆÊ’u•ÏX
			elm.pos.x : 0‚Å¶‰E’†‰›B³‚Å‰EA•‰‚Å¶B
			elm.pos.y : 0‚Åã‰º’†‰›B³‚Å‰ºA•‰‚ÅãB
			elm.pos.z : 0‚Å•W€ˆÊ’uB³‚ÅƒY[ƒ€ƒAƒbƒvB•‰‚ÅƒY[ƒ€ƒ_ƒEƒ“B
			elm.time : 0‚ÅuˆÚ“®
		*/
			if(_fLoad) return taghandler_getcontinue;

//			addOrderList(elm);
			moveCamera(elm);
			return taghandler_getcontinue;
		} incontextof this,
		waitcamera : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(!_fAction)
				return taghandler_getcontinue;

			if(!_fCamera_move)
				return taghandler_getcontinue;

			if(elm.hitcancel === void){
				_scCtrl.wait(
				%[
				click : function(){
				} incontextof this,
				movecamera_end : function(){
				} incontextof this
				]
				);
			}else{
			//ƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹–³Œø
				_scCtrl.wait(
				%[
				movecamera_end : function(){
				} incontextof this
				]
				);
			}
			return taghandler_end;
		} incontextof this,

		//‘I‘ğˆ
		addselect : function(elm){
			addSelect(elm);
			return taghandler_getcontinue;
		} incontextof this,
		startselect : function(elm){
			if(_fLoad && _hitretCnt > 0){
				_hitretCnt--;

				ret_select = _logSelect[_selectCnt];
				ret_select_str = _select[_selectCnt-1];
				_selectCnt++;

				_select.clear();
				return taghandler_getcontinue;
			}

			startSelect();
			_hitretState = true;

			_scCtrl.wait(
			%[
			select : function(){
			} incontextof this
			]
			);

			return taghandler_end;
		} incontextof this,
		setselect : function(elm){
			ret_select = elm.id;
			return taghandler_getcontinue;
		} incontextof this,

		//ƒAƒNƒVƒ‡ƒ“
		action : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			return taghandler_getcontinue;
		} incontextof this,
		stopaction : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			return taghandler_getcontinue;
		} incontextof this,
		waitaction : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			//idw’è‚ª–³‚¢ê‡‚Í–³Œø
			if(elm.id === void) return taghandler_getcontinue;

			//XV‚ª‚ ‚é‚È‚ç‚±‚±‚Å‚â‚Á‚Ä‚µ‚Ü‚¤
			if(_update) update();

			//–{‘Ì
			var index  = getADVObjectIndex(elm.id, true);
			if(index == -1){
			//–{‘Ì‚ª‚È‚¢BÁ‚¦‚æ‚¤‚Æ‚µ‚Ä‚¢‚éƒIƒuƒWƒFƒNƒg‚©‚à
				index  = getADVObjectIndex(elm.id+"-trans", true);
			}

			var target;
			if(index != -1){
			//ADVƒIƒuƒWƒFƒNƒg
				target = _objList[index];
			}else if(elm.id == "ƒƒbƒZ[ƒW"){
				target = _msg;
			}else if(elm.id == "ƒJƒƒ‰"){
				target = _camera_pos;
			}else if(elm.id == "ƒtƒFƒCƒX"){
				target = _msg._sprFace;
			}else{
				return taghandler_getcontinue;
			}

			//ƒ^[ƒQƒbƒgƒIƒuƒWƒFƒNƒg‚ªƒAƒNƒVƒ‡ƒ“’†‚©
			if(!_actionList.isAction(target))
				return taghandler_getcontinue;

			//ƒ‹[ƒvƒAƒNƒVƒ‡ƒ“‚¾‚ÆI—¹‚µ‚È‚¢‚Ì‚Å–³Œø
			if(_actionList.sequence(target).isLoop())
				return taghandler_getcontinue;

			_actionWaitTarget = target;

			if(elm.hitcancel === void){
				_scCtrl.wait(
				%[
				click : function(){
				} incontextof this,
				action_end : function(){
				} incontextof this
				]
				);
			}else{
			//ƒNƒŠƒbƒNƒLƒƒƒ“ƒZƒ‹–³Œø
				_scCtrl.wait(
				%[
				action_end : function(){
				} incontextof this
				]
				);
			}
			return taghandler_end;
		} incontextof this,

		//ƒLƒƒƒ‰ƒAƒNƒVƒ‡ƒ“—pƒAƒNƒVƒ‡ƒ“Eƒ‰ƒbƒp[
		//À•WˆÚ“®
		move : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(elm.left !== void) elm.mx = -int(elm.left);
			else if(elm.right !== void) elm.mx = int(elm.right);
			if(elm.top !== void) elm.my = -int(elm.top);
			else if(elm.bottom !== void) elm.my = int(elm.bottom);

			elm.tagname = "action";		//action‚Æ‚µ‚Ä“o˜^
			elm.action = "ActionAdvMove";
			addOrderList(elm);
			_update |= UPDATE_BUSTUP;
			return taghandler_getcontinue;
		} incontextof this,
		//“oê
		enter : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(elm.mx !== void) elm.mx = int(elm.mx);
			else if(elm.left !== void) elm.mx = -int(elm.left);
			else if(elm.right !== void) elm.mx = int(elm.right);
			else elm.mx = -100;
			elm.x = int(elm.x) + int(elm.mx);
			if(elm.my !== void) elm.my = int(elm.my);
			else if(elm.top !== void) elm.my = -int(elm.top);
			else if(elm.bottom !== void) elm.my = int(elm.bottom);
			elm.y = int(elm.y) + int(elm.my);

			//ƒtƒ@ƒCƒ‹–¼‚©‚çID‚ğ’²‚×‚é
			var info = new ADVObjectInfo();
			SetupBustup(info, elm.file);
			//id‚ªw’è‚³‚ê‚Ä‚¢‚é‚Æ‚«‚Í‚»‚ê‚ğg—p‚·‚é
			if(elm.id !== void) info.id = elm.id;

			//char‚Æ‚µ‚Ä“o˜^
			elm.tagname = "char";
			//elm.tempPosition = true;	//À•Ww’è‚ª‚ ‚Á‚Ä‚à©“®ˆÊ’u’²®İ’è‚ğ•Û‚³‚¹‚é
			addOrderList(elm);
			_update |= UPDATE_BUSTUP;

			//action‚Æ‚µ‚Ä“o˜^
			addOrderList(%[tagname:"action", id:info.id, action:"ActionAdvMove", mx:-elm.mx, my:-elm.my, cycle:elm.cycle, accel:elm.accel]);
			return taghandler_getcontinue;
		} incontextof this,
		//‹‚é
		leave : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(elm.mx !== void) elm.mx = int(elm.mx);
			else if(elm.left !== void) elm.mx = -int(elm.left);
			else if(elm.right !== void) elm.mx = int(elm.right);
			else elm.mx = 100;
			if(elm.my !== void) elm.my = int(elm.my);
			else if(elm.top !== void) elm.my = -int(elm.top);
			else if(elm.bottom !== void) elm.my = int(elm.bottom);
			elm.y = int(elm.y) + int(elm.my);

			elm.tagname = "action";		//action‚Æ‚µ‚Ä“o˜^
			elm.action = "ActionAdvMoveFadeOut";
			addOrderList(elm);

			addOrderList(%[tagname:"clearchar", id:elm.id]);

			_fBustupAutoPositioning = false;			//©“®ˆÊ’u’²®‚ğ–³Œø‚ÉB

			_update |= UPDATE_BUSTUP;
			return taghandler_getcontinue;
		} incontextof this,

		//ƒJƒbƒgƒCƒ“
		cutin : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			if(elm.file !== void || elm.hide !== void)
				_update |= UPDATE_CUTIN;

			return taghandler_getcontinue;
		} incontextof this,

		//ƒtƒ‰ƒOŒn
		onflag : function(elm){
			onFlag(elm.id);
			return taghandler_getcontinue;
		} incontextof this,
		offflag : function(elm){
			offFlag(elm.id);
			return taghandler_getcontinue;
		} incontextof this,
		setparam : function(elm){
			var pos = PointStrToNum(elm.arg);
			setParam(pos.x, pos.y);
			return taghandler_getcontinue;
		} incontextof this,
		addparam : function(elm){
			var pos = PointStrToNum(elm.arg);
			addParam(pos.x, pos.y);
			return taghandler_getcontinue;
		} incontextof this,
		clearparam : function(elm){
			var pos = PointStrToNum(elm.arg);
			clearParam(pos.x, pos.y);
			return taghandler_getcontinue;
		} incontextof this,
		//ƒOƒ[ƒoƒ‹ƒtƒ‰ƒO
		onglobalflag : function(elm){
			onGlobalFlag(elm.id);
			return taghandler_getcontinue;
		} incontextof this,
		offglobalflag : function(elm){
			offGlobalFlag(elm.id);
			return taghandler_getcontinue;
		} incontextof this,

		//‰¹ŠyEŒø‰Ê‰¹Œn
		playbgm : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			playBgm(elm);
			return taghandler_getcontinue;
		} incontextof this,

		stopbgm : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			stopBgm(elm);
			return taghandler_getcontinue;
		} incontextof this,

		playse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			playSe(elm);
			return taghandler_getcontinue;
		} incontextof this,

		stopse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			stopSe(elm);
			return taghandler_getcontinue;
		} incontextof this,

		playenvse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			playEnvSe(elm);
			return taghandler_getcontinue;
		} incontextof this,

		stopenvse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			stopEnvSe(elm);
			return taghandler_getcontinue;
		} incontextof this,

		playvoice : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			playVoice(elm.file, elm.pan);
			return taghandler_getcontinue;
		} incontextof this,
		stopvoice : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			stopVoice(elm);
			return taghandler_getcontinue;
		} incontextof this,

		//‰‰oŒn
		blackout : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			elm.tagname = "cg";
			elm.file = "BLACK";
			addOrderList(elm);
			_update |= UPDATE_CG;

			elm.color = "BLACK";
			elm.enter = elm.time;
			elm.leave = 0;

			var func = getHandlers()["flash"];
			return func(elm);

		} incontextof this,
		whiteout : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			elm.tagname = "cg";
			elm.file = "WHITE";
			addOrderList(elm);
			_update |= UPDATE_CG;

			elm.color = "WHITE";
			elm.enter = elm.time;
			elm.leave = 0;

			var func = getHandlers()["flash"];
			return func(elm);
		} incontextof this,
		colorout : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			colorOut(elm);

			if(isSkip())
				return taghandler_end;

			if(!_sprTrans.isTransition()){
				return taghandler_end;
			}else if(elm.hitcancel === void){
				_scCtrl.wait(
				%[
				click : function(){
				} incontextof this,
				transition_end : function(){
				} incontextof this
				]
				);
			}else{
				_scCtrl.wait(
				%[
				transition_end : function(){
				} incontextof this
				]
				);
			}

			return taghandler_end;
		} incontextof this,

		flash : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip()){
				flashEnter(elm);
				flashLeave();
				return taghandler_end;
			}

			if(_sprFlash !== void){
				flashEnd();
			}

			flashEnter(elm);

			if(elm.hitcancel === void){
				_scCtrl.wait(
				%[
				click : function(){
				} incontextof this,
				flash_end : function(){
				} incontextof this
				]
				);
			}else{
				_scCtrl.wait(
				%[
				flash_end : function(){
				} incontextof this
				]
				);
			}

			return taghandler_end;
		} incontextof this,

		tone : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			_update |= UPDATE_CG;

			return taghandler_getcontinue;
		} incontextof this,

		focus : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			addOrderList(elm);
			_update |= UPDATE_CG;
			//focus(elm);
			return taghandler_getcontinue;
		} incontextof this,

		//ƒVƒiƒŠƒI§ŒäŒn
		//w’èŠÔ‘Ò‚¿
		wait : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			if(elm.hitcancel === void){
				_scCtrl.waitTimeOut( %[
				click : function(){
				} incontextof this,
				timeout : function(){
				} incontextof this
				],
				elm.time);
			}else{
				_scCtrl.waitTimeOut( %[
				timeout : function(){
				} incontextof this
				],
				elm.time);
			}
			return taghandler_end;
		} incontextof this,
		//‰¹Šy‚ÌI—¹‘Ò‚¿
		waitbgm : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			if(BGM.isPlay()){
				_scCtrl.wait( %[
				click : function(){
				} incontextof this,
				bgm_end : function(){
				} incontextof this
				]);
				return taghandler_end;
			}else{
				return taghandler_getcontinue;
			}
		} incontextof this,
		//Œø‰Ê‰¹‚ÌI—¹‘Ò‚¿
		waitse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			if(SE.isPlay()){
				_scCtrl.wait( %[
				click : function(){
				} incontextof this,
				se_end : function(){
				} incontextof this
				]);
				return taghandler_end;
			}else{
				return taghandler_getcontinue;
			}
		} incontextof this,
		//ŠÂ‹«‰¹‚ÌI—¹‘Ò‚¿
		waitenvse : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			var f = false;
			if(elm.id !== void){
			//idw’è‚ª‚ ‚Á‚½
				var obj;
				if((obj = ENVSE.objectOfId(elm.id, false)) != -1){
					if(obj._waitEnding)
					//ƒoƒbƒtƒ@‚ª‘¶İ‚µ‚Ä~‚Ü‚ë‚¤‚Æ‚µ‚Ä‚¢‚é
						f = true;
				}
			}else{
			//w’è‚È‚µ
				f = ENVSE.isPlay();
			}

			if(f){
				if(elm.id === void){
					_scCtrl.wait( %[
					click : function(){
					} incontextof this,
					envse_end : function(){
					} incontextof this
					]);
				}else{
					var wait = %[];
					wait.click = function {};
					wait["envse_end:"+elm.id.toUpperCase()] = function {};
					_scCtrl.wait(wait);
				}
				return taghandler_end;
			}else{
				return taghandler_getcontinue;
			}
		} incontextof this,
		//‰¹º‚ÌI—¹‘Ò‚¿
		waitvoice : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			var fPlay = VOICE.isPlay();

			if(fPlay){
				if(elm.hitcancel === void){
					_scCtrl.wait( %[
					click : function(){
					} incontextof this,
					voice_end : function(){
					} incontextof this
					]);
				}else{
					_scCtrl.wait( %[
					voice_end : function(){
					} incontextof this
					]);
				}
				return taghandler_end;
			}else{
				return taghandler_getcontinue;
			}
		} incontextof this,
		pausebgm : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			pauseBgm();
		} incontextof this,
		restartbgm : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			restartBgm();
		} incontextof this,
		//ƒgƒ‰ƒ“ƒWƒbƒVƒ‡ƒ“‚ÌI—¹‘Ò‚¿
		waittransition : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			_scCtrl.wait( %[
			click : function(){
			} incontextof this,
			transition_end : function(){
			} incontextof this
			]);
			return taghandler_end;
		} incontextof this,
		//ƒXƒNƒ[ƒ‹‚ÌI—¹‘Ò‚¿
		waitscroll : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			if(isSkip())
				return taghandler_end;

			_scCtrl.wait( %[
			click : function(){
			} incontextof this,
			scroll_end : function(){
			} incontextof this
			]);
			return taghandler_end;
		} incontextof this,

		//ƒtƒ@ƒCƒ‹ƒ`ƒFƒ“ƒW
		change : function(elm){
			change(elm.target);
			return taghandler_getcontinue;
		} incontextof this,

		//ƒƒS‚É–ß‚é
		tologo : function(elm){
			returnTo(SCENE_LOGO);

			return taghandler_end;
		} incontextof this,

		//ƒ^ƒCƒgƒ‹‚É–ß‚é
		totitle : function(elm){
			returnTo(SCENE_TITLE);

			return taghandler_end;
		} incontextof this,

		//‰ñ‘z’†‚È‚ç‰ñ‘z‚É–ß‚é
		recollect_end : function(elm){
			if(_fRecollect){
				returnTo(SCENE_MEMORIES);
				return taghandler_end;
			}

			//ƒtƒ‰ƒO‚ğƒIƒ“
			if(elm.id !== void) SetGlobalFlag(int elm.id, true);

			return taghandler_getcontinue;
		} incontextof this,

		//ƒVƒiƒŠƒII’[
		terminate : function(elm){
			returnTo(SCENE_LOGO);

			return taghandler_end;
		} incontextof this,

		//ƒ€[ƒr[‚ÌÄ¶
		playmovie : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			playMovie(elm);

			if(elm.hitcancel === void){
				_scCtrl.wait( %[
				rclick : function(){
				} incontextof this,
				movie_end : function(){
				} incontextof this
				]);
			}else{
				_scCtrl.wait( %[
				movie_end : function(){
				} incontextof this
				]);
			}

			return taghandler_end;
		} incontextof this,

		staffroll : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			staffroll(elm);

			_scCtrl.wait( %[
			staffroll_end : function(){
			} incontextof this
			]);
		} incontextof this,

		//•Â‚¶‚éƒ{ƒ^ƒ“—LŒø^–³Œø
		canclose : function(elm){
			if(elm.yes !== void) game.enableClose = true;
			if(elm.no !== void) game.enableClose = false;
			return taghandler_getcontinue;
		} incontextof this,

		//ƒfƒoƒbƒN—pƒƒbƒZ[ƒW
		dm : function(elm){
			dm(elm.text);
			return taghandler_getcontinue;
		} incontextof this,

		//ƒQ[ƒ€ŒÅ—LƒRƒ}ƒ“ƒh
		eyecatch : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			eyeCatch(elm);

			_scCtrl.wait( %[
			eyecatch_end : function(){
			} incontextof this
			]);

			return taghandler_end;
		} incontextof this,
		changedate : function(elm){
			if(_fLoad) return taghandler_getcontinue;
			return taghandler_getcontinue;
		} incontextof this,
		messageframe : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			messageFrame(elm);

			return taghandler_getcontinue;
		} incontextof this,
		face : function(elm){
			if(_fLoad) return taghandler_getcontinue;

			var file = "";
			if(elm.hide !== void){
				file = "hide";
			}else if(elm.hideonce !== void){
				file = "hideonce";
			}else if(elm.show !== void){
				file = "show";
			}else if(elm.file !== void){
				file = elm.file;
			}
			_face = file;

			return taghandler_getcontinue;
		} incontextof this

		];
	}

	//ƒRƒ}ƒ“ƒhƒtƒ@ƒ“ƒNƒVƒ‡ƒ“
	function talk(name="ĞÄÖ®Éù", voice="", pan=""){
		cleaningADVObjectList();

		_name = name;
		_mess = "";
		_voice = voice;
		_pan = pan;
	}

	function ch(code){
		_mess += code;
	}

	function hitret(id=0){
		var fLoadEnd = false;
		if(_fLoad){
			loadEnd();
			fLoadEnd = true;
		}else{
			if(_update) update();
			if(_orderList.count) processOrder(_orderList);

			_hitretNum++;
		}

		_quickSave = false;

		//•\¦–¼‚ÆƒLƒƒƒ‰–¼‚ğ•ª—£
		//@talk •\¦–¼/ƒLƒƒƒ‰–¼
		//•ª—£‚Å‚«‚È‚¢‚à‚Ì‚Í•\¦–¼=ƒLƒƒƒ‰–¼
		var name = _name.split("/");
		var trueName;
		var dispName;
		if(name.count == 1){
			dispName = name[0];
		}else{
			dispName = name[1];
		}
		trueName = name[0];

		//•¶š‘•ü
		for(var i=0;i<_partMess.count;i++){
			with(_partMess[i]){
				var mess = .mess;
				var reg = new RegExp(mess, "g");
				if(.face !== void){
					var replace = "$f:" + .face + ";" + mess + "$fd;";
					_mess = _mess.replace(reg, replace);
				}
				if(.color !== void){
					var color = .color;
					var bkcolor = .bkcolor;
					var replace = "$c:" + color + "," + bkcolor + ";" + mess + "$c;";
					_mess = _mess.replace(reg, replace);
				}
				if(.size !== void){
					var replace = "$s:" + .size + ";" + mess + "$sd;";
					_mess = _mess.replace(reg, replace);
				}
				if(.bold !== void){
					var replace = "$b;" + mess + "$bd;";
					_mess = _mess.replace(reg, replace);
				}
				if(.italic !== void){
					var replace = "$i;" + mess + "$id;";
					_mess = _mess.replace(reg, replace);
				}
				invalidate reg;
			}
		}
		_partMess.clear();
		//ƒ‹ƒr
		for(var i=0;i<_ruby.count;i++){
			var mess = _ruby[i].mess;
			var read = _ruby[i].read;
			var replace = "$r:" + mess + "," + read + ";";
			var reg = new RegExp(mess);
			_mess = _mess.replace(reg, replace);
			invalidate reg;
		}
		_ruby.clear();

		//Šù“Çƒtƒ‰ƒOƒ`ƒFƒbƒN
		var fRead = ChkReadFlag(id);
		if(!fRead){
			SetReadFlag(id, true);
			if(isSkip(true) && CONFIG.readSkip == 1) skip(false);	//ƒXƒLƒbƒv‚ğ‰ğœ‚·‚é
		}

		//‰¹ºÄ¶
		playVoice(_voice, _pan);

		//ƒƒO•Û‘¶
		if(fLoadEnd == false){
			_logName.add(_name);
			_logMess.add(_mess);
			_logVoice.add(_voice);
			_logParam.add(%[font:%[], pan:_pan]);
			(Dictionary.assign incontextof _logParam[_logParam.count-1].font)(_fontElm);
		}

		_autoState = 0;	//ƒI[ƒgó‘ÔƒŠƒZƒbƒg

		//ƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“‚ª”­¶‚µ‚Ä‚È‚¢‚Ì‚ÅŠ®—¹ˆµ‚¢
		if(!_sprTrans.isTransition())
			checkAutoEvent(AUTOSTATE_TRANSITION_END);

		//‰¹º‚ÍÄ¶‚³‚ê‚È‚©‚Á‚½‚Ì‚ÅŠ®—¹ˆµ‚¢
		if(!_fPlayedVoice)
			checkAutoEvent(AUTOSTATE_VOICE_END);

		_advHide = false;	//ƒƒbƒZ[ƒW•\¦‚Ì‰ğœ
		//ƒƒbƒZ[ƒWo—Í
		outputMessage(dispName, _mess, _voice, _pan, fRead, trueName);

		if(_strSearch.length != 0 && isSkip(true)){
			if(_mess.indexOf(_strSearch) != -1){
			//ŒŸõ•¶š—ñ‚ªŒ©‚Â‚©‚Á‚½
				_strSearch = "";
				skip(false);
			}
		}

		//ƒXƒLƒbƒv’â~—v‹
		if(_requestStopSkip){
			if(isSkip()) skip(false);
			_requestStopSkip = false;
		}
	}

	function outputMessage(name, mess, voice, pan, fRead, trueName=""){
		if(_fFont){
			_msg.output(name, mess, voice, pan, isSkip(), _fontElm, _fIgnoreKinsoku, fRead, trueName, _face);
		}else{
			_msg.output(name, mess, voice, pan, isSkip(), null, _fIgnoreKinsoku, fRead, trueName, _face);
		}

		if(!_msg.isShow()) show(300);

		if(_fFont) resetFontElm();
		if(_fIgnoreKinsoku) _fIgnoreKinsoku = false;
	}

	function resetFontElm(){
		_fFont = false;
		_fontElm.face = ADV_FONT_MESS_FACE;
		_fontElm.size = ADV_FONT_MESS_SIZE;
		_fontElm.indent = ADV_FONT_MESS_INDENT;
		_fontElm.face = ADV_FONT_MESS_FACE;
		_fontElm.bold = 0;
		_fontElm.italic = 0;
		_fontElm.color = -1;
		_fontElm.bkcolor = -1;
	}

	function transitionComplete(dest, src){
		_sprTrans.stopTransition();
		_sprTrans.visible = false;

		_autoState |= AUTOSTATE_TRANSITION_END;

		if(isTransition() == false){
			if(_sprTrans == dest){
				_scCtrl.trigger("transition_end");

				if(checkAutoEvent(AUTOSTATE_TRANSITION_END) && _hitretState){
					if(_fPlayVoice){
//					if(_fPlayedVoice){
						click();
					}else{
						startAutoTimer();
					}
				}

				//ƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“‚ªI—¹‚µ‚½‚çADVScreen‚ğ•Â‚¶‚é‚æ‚¤‚É‚·‚é
				if(_end) close();
			}
		}
	}

	function cg(elm=%[]){
	//elm.file
	//elm.pos
		_update |= UPDATE_CG;
		_fBustupAutoPositioning = true;

		//ƒAƒNƒVƒ‡ƒ“’†‚È‚ç~‚ß‚é
		if(_actionList.count) _actionList.stopAction();

		//ƒoƒXƒgƒAƒbƒv‘SÁ‹
		//elm.clearƒ^ƒO‚ª“o˜^‚³‚ê‚Ä‚¢‚È‚¢A‚à‚µ‚­‚Í1‚È‚çÁ‹
		if(elm.clear === void){
		//ƒ^ƒO‚È‚µ
			clearChar();
			cutin(%[hide:1]);
		}else if(elm.clear == 1){
		//1‚ªİ’è‚³‚ê‚Ä‚¢‚é
			clearChar();
			cutin(%[hide:1]);
		}

		var info = new ADVObjectInfo();
		SetupCg(info, elm.file);
		var id = getADVObjectIndex("”wŒi");
		with(_objList[id]){
			.info.copy(info);

			if(elm.color === void){
				var success = .setup(elm);

				@if(__DEBUGMODE__)
				//ƒtƒ@ƒCƒ‹î•ñ‚ğ‘‚«‚Ş
					if(!success){
						.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);
						._spr.fillRect(0, 0, .width, .height, RGBA(64, 64, 64));
						info.center.set(WINDOW_WIDTH/2, WINDOW_HEIGHT/2);
					}
					if(debug.tglSupExp.state){
						var text = CG_INFO[elm.file];
						if(text === void) text = elm.file;
						._spr.font.height = 32 + random(32);
						var w = ._spr.font.getTextWidth(text);
						._spr.drawText((._spr.width-w)/2, (._spr.height-._spr.font.height)/2-280, text, RGB(127+random(128), 127+random(128), 127+random(128)), 255, true, 1024, 0x0, 2);
					}
				@endif
			}else{
				._spr.setImageSize(WINDOW_WIDTH, WINDOW_HEIGHT);
				._spr.fillRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT, int(elm.color) | 0xff000000);
			}

			.setSizeToImageSize();

			if(info.center.x == ADVOBJ_NULL){
				.setCenter(int(.imageWidth/2), int(.imageHeight/2));
			}else{
				.setCenter(info.center.x, info.center.y);
			}

			if(elm.blur !== void){
				.doBoxBlur(int(elm.blur), int(elm.blur));
			}

			@if(__DEBUGMODE__)
				debug.setCameraRange(0, 0, .imageWidth, .imageHeight, ._spr._image);
				debug.setCameraPos(_camera_pos.x, _camera_pos.y);
			@endif
			//ƒJƒƒ‰ˆÊ’u‚Ì’²®
			if(elm.pos === void){
				moveCamera(%[pos:"0,0,0", time:0]);		//’†‰›
			}else{
				moveCamera(%[pos:elm.pos, time:0]);		//”CˆÓ
			}
		}
		invalidate info;
	}

	function char(elm=%[]){
	//elm.file
	//elm.pos
	//elm.trans
		var check = UPDATE_CG|UPDATE_BUSTUP;
		var info = new ADVObjectInfo();
		SetupBustup(info, elm.file);	//ƒoƒXƒgƒAƒbƒv‚Ìî•ñ‚ğæ“¾
		if(info.id == -1){
			dm("ƒoƒXƒgƒAƒbƒvƒtƒ@ƒCƒ‹‚Å‚Í‚ ‚è‚Ü‚¹‚ñ : " + elm.file);
			return;
		}

		//id‚ªw’è‚³‚ê‚Ä‚¢‚é‚Æ‚«‚Í‚»‚ê‚ğg—p‚·‚é
		if(elm.id !== void) info.id = elm.id;

		var newObject = false;
		var transIndex;
		var index = getADVObjectIndex(info.id);
		var preWorld = new Point();
		var preFocus = -1;
		var preTone = "";
		var preTrans = -1;

		if(index == -1){
		//V‹KID
			index = addADVObject(info.id);
			newObject = true;
			_objList[index].fresh = true;
		}else{
		//Šù‚É‘¶İ‚·‚éID‚È‚Ì‚ÅA“ü‚ê‘Ö‚¦ˆ—

			//‚È‚É‚©ƒAƒNƒVƒ‡ƒ“’†‚È‚ç’â~‚·‚é
			if(_actionList.isAction(_objList[index]))
				_actionList.stopAction(_objList[index]);

			preWorld.set(_objList[index].world);	//Œ»İ‚ÌÀ•W‚ğ•Û‘¶
			preFocus = _objList[index]._focus;
			preTone = _objList[index]._tone;
			preTrans = _objList[index].opacity;

			transIndex = getADVObjectIndex(info.id+"-trans");
			if(transIndex != -1){
			//ID+"-trans" ‚ª‘¶İ‚·‚é‚Æ‚¢‚¤‚±‚Æ‚ÍAƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“ˆ—’†‚Æ‚¢‚¤‚±‚Æ‚È‚Ì‚Åíœ‚µ‚ÄV‹KID‚Æ‚µ‚Äˆµ‚¤B
				removeADVObject(info.id+"-trans");
				newObject = true;
			}else{
				//Œ»İ‚ÌID‚ğ•ÏX
				_objList[index].id = _objList[index].id + "-trans";
				_objList[index].destroy = ADVOBJ_DESTROY_WAIT;	//•K—v‚È‚­‚È‚Á‚½‚ç©–Å‚³‚¹‚é
				transIndex = index;
			}

			//V‹KADVObjectì¬
			index = addADVObject(info.id);
			_objList[index].absolute = _objList[transIndex].absolute;
		}
		with(_objList[index]){
			elm.file = info.file;
			elm.diff = info.diffBase;

			.setup(elm);
			.info.copy(info);

			if(preFocus != -1) .focus(preFocus);
			if(preTone != "") .tone(preTone);

			.kind = ADVOBJ_BUSTUP;
			.relate = info.relate;

			if(info.center.x == ADVOBJ_NULL){
				.setCenter(.imageWidth/2, .imageHeight - 50);
			}else{
				.setCenter(info.center.x, info.center.y);
			}

			var fAppointPos = false;
			var pos = new Point(0, 0, 50);
			if(elm.pos !== void){
				pos = PointStrToNum(elm.pos);
				fAppointPos = true;
			}
			if(elm.x !== void){
				pos.x = int(elm.x);
				fAppointPos = true;
			}
			if(elm.y !== void){
				pos.y = int(elm.y);
				fAppointPos = true;
			}
			if(elm.z !== void){
				pos.z = int(elm.z);
				fAppointPos = true;
			}else{
				pos.z = info.zOrder;
			}
			preWorld.z = pos.z;

			if(elm.wpos !== void){
				pos = PointStrToNum(elm.wpos);
				fAppointPos = true;
			}

			//ƒXƒNƒŠ[ƒ“À•Ww’è‚ğƒ[ƒ‹ƒhÀ•W‚É•ÏŠ·
			//var tempY = pos.y;	//YÀ•W•Û‘¶
			//pos = screenToWorld(_camera_pos, pos);
			//pos.y = tempY;	//YÀ•W‚ÍƒAƒCƒ‰ƒCƒ“‚ğ‡‚í‚¹‚é•K—v‚ª‚ ‚é‚©‚çŒ³‚É–ß‚·B

			var fActivationChange = false;		//^‚È‚çƒgƒ‰ƒ“ƒWƒVƒ‡ƒ“‚ğg‚í‚¸ƒAƒNƒeƒBƒx[ƒVƒ‡ƒ“‚ÅŒÂ•Ê‚Éˆ—‚·‚é

			//‘S‰æ–ÊXV‚Ìê‡‚ÍƒAƒNƒeƒBƒx[ƒVƒ‡ƒ“‚Åˆ—
			if(_update & UPDATE_CG) fActivationChange = true;

			var trans = 255;
			if(elm.trans !== void){
				preTrans = trans = int(elm.trans);
				fActivationChange = true;
			}
			var time = 500;
			if(elm.time !== void)
				time = int(elm.time);
			if(isSkip())
				time = 0;

			//XVŠÔ‚ğ‰‰o‘¬“xİ’è‚Å•â³
			time = ReviceEffectSpeed(time);

			if(fAppointPos == false && newObject == false){
			//À•Ww’è‚ª–³‚­A‚©‚ÂŠù‘¶ƒIƒuƒWƒFƒNƒg‚Ìê‡‚ÍˆÈ‘O‚ÌÀ•W‚ğˆø‚«Œp‚®
				.setWorldPos(preWorld.x, preWorld.y, preWorld.z);
			}else{
			//À•Ww’è‚ª‚ ‚Á‚½‚Ì‚ÅA‚»‚¿‚ç‚ğg‚¤
				.setWorldPos(pos.x, pos.y, pos.z);
			}

			if(fAppointPos){							//À•Ww’è‚ª‚ ‚èA
				if(elm.tempPosition === void)			//tempPositionƒ^ƒO‚ª‚È‚¯‚ê‚ÎA
					_fBustupAutoPositioning = false;	//ƒoƒXƒgƒAƒbƒv‚Ì©“®ˆÊ’u’²®‚ğ–³Œø‚ÉB
				else
					._tempPositioning = true;			//‰¼ˆÊ’uİ’èF©“®ˆÊ’u’²®‚Ì‰e‹¿‚ğó‚¯‚È‚¢
			}

			.setBasePos(WINDOW_CENTER_X, WINDOW_CENTER_Y);

			var order = info.order;
			if(elm.order !== void)
				.info.order = order = elm.order;

			if(.absolute != order) fActivationChange = true;
			.absolute = order;

			if(preTrans == -1)
				.opacity = trans;
			else
				.opacity = preTrans;

			.onPaint();				//ˆê‰ñƒŒƒCƒ„‚ğXV‚·‚é

			if(elm.blur !== void)
				.doBoxBlur(int(elm.blur), int(elm.blur));

			if(newObject){
				var pos = worldToScreen(_camera_pos, .getWorldPos());
				.setPos(pos.x, pos.y);
				.visible = true;
				if((_update & check) == check || time == 0){
					.opacity = trans;
				}else{
					.opacity = 0;
					.setBlendingEnvelope(trans);
					.beginActivation(time);
				}
			}else{
				if(time == 0){
					.visible = true;
					removeADVObject(_objList[transIndex].info.id);
				}else{
					if(fActivationChange){
					//ƒI[ƒ_[‚É•ÏXA‚Ü‚½‚Í‘S‰æ–ÊXV‚Ìê‡‚Í•ÊX‚Éˆ—‚·‚éB
						_objList[transIndex].setBlendingEnvelope(0);
						_objList[transIndex].beginActivation(time);
						.visible = true;
						.opacity = 0;
						.setBlendingEnvelope(trans);
						.beginActivation(time);
					}else{
						_objList[transIndex].beginTransition("crossfade", true, _objList[index], %[time:time]);
					}
				}
			}

			.setTransitionCompleteCall(transitionComplete);

			invalidate pos;
		}
		if(elm.action !== void){
			elm.id = info.id;
			asyncAction(elm);
		}

		invalidate info;
		_update |= UPDATE_BUSTUP;
	}

	function clearChar(elm=%[]){
	//elm.id
		if(_update & UPDATE_CG){
		//‘S‰æ–ÊXV‚Ì‚ÍƒoƒXƒgƒAƒbƒv‚ğ‚»‚Ì‚Ü‚ÜÁ‚·
			_fBustupAutoPositioning = true;
			removeADVObject(ADVOBJ_BUSTUP);
		}else{
		//ƒoƒXƒgƒAƒbƒvXV‚Ì‚ÍƒtƒF[ƒhƒAƒEƒg‚³‚¹‚é
			var time = 500;
			if(elm.time !== void)
				time = int(elm.time);
			if(isSkip())
				time = 0;

			//XVŠÔ‚ğ‰‰o‘¬“xİ’è‚Å•â³
			time = ReviceEffectSpeed(time);

			if(elm.id === void)
				elm.id = -1;

			if(elm.id != -1){
			//ŒÂ•ÊÁ‹
				var index = getADVObjectIndex(elm.id);
				if(index != -1){
					with(_objList[index]){
						if(time == 0){
							removeADVObject(.info.id);
						}else if(.id.indexOf("-trans") == -1){
							.id = .id + "-trans";	//ID‚ğ•ÏX‚·‚é
							.setBlendingEnvelope(0);
							.beginActivation(time);
							.destroy = ADVOBJ_DESTROY_WAIT;
						}
					}
				}
			}else{
			//‘SÁ‹
				_fBustupAutoPositioning = true;
				for(var i=_objList.count-1;i>=0;i--){
					with(_objList[i]){
						if(.kind == ADVOBJ_BUSTUP){
							if(time == 0){
								removeADVObject(.info.id);
							}else if(.id.indexOf("-trans") == -1){
								.id = .id + "-trans";	//ID‚ğ•ÏX‚·‚é
								.setBlendingEnvelope(0);
								.beginActivation(time);
								.destroy = ADVOBJ_DESTROY_WAIT;
							}
						}
					}
				}
			}
		}
		_update |= UPDATE_BUSTUP;
	}

	function cutin(elm){
	//elm.file
	//elm.pos
	//elm.action
		//if(elm.file === void) return;

		if(elm.hide !== void){
			_cutinParam.file = "";
			invalidate _cutin;
			return;
		}
		if(elm.file !== void){
			invalidate _cutin;
			_cutin = new ADVObject(window, this);
			with(_cutin){
				SetupSd(elm.file);	//‚½‚¾‚Ìƒtƒ‰ƒO—§‚Ä
				.setup(elm);
				.kind = ADVOBJ_SCREEN;
				.absolute = ADVLAYER_CUTIN;
				.setCenter(.width/2, .height/2);
				var pos = new Point(0, 0, 0);
				if(elm.pos !== void){
					pos = PointStrToNum(elm.pos);
					_cutinParam.pos = elm.pos;
				}
				.setPos(CUTIN_X + pos.x, CUTIN_Y + pos.y);
				.visible = true;
			}
			_cutinParam.file = elm.file;
		}
		if(elm.action !== void){
			//ƒAƒNƒVƒ‡ƒ“’†‚È‚çI—¹‚³‚¹‚é
			if(_actionList.isAction(_cutin))
				_actionList.stopAction(_cutin);

			elm.id = "ƒJƒbƒgƒCƒ“";
			if(elm.move !== void || elm.mx !== void || elm.my !== void){
				if(elm.move !== void){
					var move = PointStrToNum(elm.move);
					elm.mx = move.x;
					elm.my = move.y;
				}
				if(elm.mx === void)	elm.mx = 0;
				else				elm.mx = int(elm.mx);
				if(elm.my === void)	elm.my = 0;
				else				elm.my = int(elm.my);

				elm.mx += _cutin.left;
				elm.my += _cutin.top;

				_cutinParam.pos = PointNumToStr(elm.mx-CUTIN_X, elm.my-CUTIN_Y);
			}

			if(elm.accel === void) elm.accel = 2;
			asyncAction(elm);
		}
	}

	//‰æ–Êƒtƒ‰ƒbƒVƒ…
	function flashEnter(elm){
		var color = "WHITE";
		var enter = 200;
		_flashLeave = 200;

		if(elm.color !== void) color = elm.color;
		if(elm.enter !== void) enter = int(elm.enter);
		if(elm.leave !== void) _flashLeave = int(elm.leave);

		invalidate _sprFlash;
		_sprFlash = new Sprite(window, this);
		with(_sprFlash){
			.setImageSize(WINDOW_WIDTH, WINDOW_HEIGHT);
			.setSizeToImageSize();

			FillRect(_sprFlash, color);
			color = color.toUpperCase();
			.hitType = htMask;
			.hitThreshold = 256;
			.opacity = 0;
			.absolute = ADVLAYER_FLASH;
			.setBlendingEnvelope(255);
			.visible = true;
			.setTransitionCompleteCall(flashLeave, true);
			.beginActivation(enter);

			if(elm.add !== void) _sprFlash.type = ltAdditive;
			if(elm.sub !== void) _sprFlash.type = ltSubtractive;
		}
	}
	function flashLeave(){
		if(!isvalid this) return;
		if(_sprFlash === void) return;

		update(%[flush:1, time:0]);
		with(_sprFlash){
			.setTransitionCompleteCall(flashEnd, true);
			.setBlendingEnvelope(0);
			.beginActivation(_flashLeave);
		}

		_scCtrl.trigger("flash_end");
	}
	function flashEnd(){
		if(!isvalid this) return;
		if(_sprFlash === void) return;

		_sprFlash.setTransitionCompleteCall();
		_sprFlash.visible = false;
		invalidate _sprFlash;
		_sprFlash = void;

		//flashLeave‚ğ’Ê‰ß‚µ‚È‚¢ê‡‚ª‚ ‚é‚©‚çA‚±‚±‚Å‚àƒgƒŠƒK[‚ğˆø‚­
		_scCtrl.trigger("flash_end");
	}

	function tone(elm){
		if(elm.id === void && elm.once === void && elm.all === void){
		//elm.id‚ª‚È‚¢‚Æ‚¢‚¤‚±‚Æ‚ÍAƒg[ƒ“‰ğœ
			for(var i=_objList.count-1;i>=0;i--){
				if(_objList[i].kind != ADVOBJ_SCREEN && _objList[i]._tone != "normal"){
					_objList[i].tone("normal");
				}
			}
		}else{
			if(elm.all !== void){
			//‘S‚Ä
				for(var i=_objList.count-1;i>=0;i--){
					if(_objList[i].kind != ADVOBJ_SCREEN){
						_objList[i].tone(elm.type);
					}
				}
			}else if(elm.id !== void){
			//w’èƒIƒuƒWƒFƒNƒg
				for(var i=_objList.count-1;i>=0;i--){
					if(_objList[i].kind != ADVOBJ_SCREEN && _objList[i].id == elm.id){
						_objList[i].tone(elm.type);
					}
				}
			}
		}
	}

	function focus(elm){
		if(elm.id === void && elm.once === void && elm.all === void){
		//elm.id, elm.once, elm.all‚ª‚È‚¢‚Æ‚¢‚¤‚±‚Æ‚ÍAƒtƒH[ƒJƒX‰ğœ
			for(var i=_objList.count-1;i>=0;i--){
				if(_objList[i].kind != ADVOBJ_SCREEN && _objList[i].id != elm.id){
					_objList[i].focus(0);
				}
			}
		}else{
			if(elm.depth === void) elm.depth = 4;

			if(elm.all !== void){
			//‘S‚Ä
				for(var i=_objList.count-1;i>=0;i--){
					_objList[i].focus(elm.depth);
				}
			}else if(elm.id !== void){
			//w’èƒIƒuƒWƒFƒNƒgˆÈŠO
				for(var i=_objList.count-1;i>=0;i--){
					if(_objList[i].kind != ADVOBJ_SCREEN && _objList[i].id != elm.id && _objList[i].id != elm.id+"-trans"){
						_objList[i].focus(elm.depth);
					}else{
						_objList[i].focus(0);
					}
				}
			}else if(elm.once !== void){
			//w’èƒIƒuƒWƒFƒNƒg‚Ì‚İ
				for(var i=_objList.count-1;i>=0;i--){
					if(_objList[i].kind != ADVOBJ_SCREEN && _objList[i].id == elm.once){
						_objList[i].focus(elm.depth);
					}else{
						_objList[i].focus(0);
					}
				}
			}
		}

		_update |= UPDATE_CG;
	}

	function requestUpdateCg(){
		_update |= UPDATE_CG;
	}

	function update(elm=%[]){
		if(!_update) return;

		//È—ªƒpƒ‰ƒ[ƒ^’²®
		if(elm.time === void) elm.time = 500;
		if(elm.transition === void) elm.transition = "crossfade";
		if(elm.rule !== void) elm.transition = "universal";

		if(isSkip())
			elm.time = 0;
		if(_fLoad)
			elm.time = 0;
		if(CONFIG.screenEffect == 0)
			elm.time = 0;

		//XVŠÔ‚ğ‰‰o‘¬“xİ’è‚Å•â³
		elm.time = ReviceEffectSpeed(elm.time);

		if(elm.flush === void) elm.flush = 0;
		if(elm.time <= 0) elm.flush = 1;

		if(_sprTrans.isTransition()){
		//‚Ü‚¾‘O‚Ìƒgƒ‰ƒ“ƒWƒbƒVƒ‡ƒ“‚ªI—¹‚µ‚Ä‚¢‚È‚¢‚È‚çI—¹‚³‚¹‚éB
			transitionComplete(_sprTrans);
		}
		for(var i=0;i<_objList.count;i++){
			if(_objList[i].isActivation()) _objList[i].flushActivation();
			if(_objList[i].isTransition()) _objList[i].stopTransition();
		}

		//Œ»İ‚Ìê–Ê‚ğƒRƒs[
		if(_update & UPDATE_CG){
			hasImage = true;
			_sprTrans.piledCopy(0, 0, this, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
			hasImage = false;
			_sprTrans.visible = true;
		}

		//ƒJƒƒ‰ˆÚ“®’†‚Ìê‡‚ÍAˆÚ“®‚ğŠ®—¹‚³‚¹‚éB
		if(_update & UPDATE_CG && _fAction){
			flushMoveCamera();
		}

		//ƒI[ƒ_[‚ğ‘Oˆ—AŒãˆ—‚É•ª‚¯‚é
		var preOrder = [];
		var postOrder = [];
		separateOrder(_orderList, preOrder, postOrder);

		//ƒI[ƒ_[‚É]‚Á‚ÄAV‚µ‚¢ê–Ê‚ğ\’z
		processOrder(preOrder, elm);

		if(_fBustupAutoPositioning){
		//ƒoƒXƒgƒAƒbƒv‚Ì©“®ˆÊ’u’²®
			autoPositioning(elm.flush);
		}

		//c‚è‚ÌƒI[ƒ_[‚ğˆ—
		processOrder(postOrder, elm);

		//ƒI[ƒ_[ƒŠƒXƒgƒNƒŠƒA
		clearOrderList();
		invalidate preOrder;
		invalidate postOrder;

		putCameraViewObject(_camera_pos);

		if(_update & UPDATE_CG){
			if(elm.transition == "crossfade"){
				_sprTrans.beginTransition("crossfade", true, this, elm);
			}else if(elm.transition == "scroll"){
				var param = %[];
				switch(elm.to){
				case   "left": param.from = sttRight; break;
				case  "right": param.from = sttLeft; break;
				case    "top": param.from = sttBottom; break;
				case "bottom": param.from = sttTop; break;
				}
				switch(elm.stay){
				case 'nostay': param.stay = ststNoStay; break;
				case 'stayback': param.stay = ststStaySrc; break;
				case 'stayfore': param.stay = ststStayDest; break;
				default: param.stay = ststNoStay; break;
				}
				param.time = elm.time;
				_sprTrans.beginTransition("scroll", true, this, param);
			}else if(elm.transition == "universal"){
				_sprTrans.beginTransition("universal", true, this, elm);
			}else{
				_sprTrans.beginTransition(elm.transition, true, this, elm);
			}
		}

		//ADVƒIƒuƒWƒFƒNƒg‚ÌV‹Kƒtƒ‰ƒO‚ğfalse‚É
		for(var i=0;i<_objList.count;i++){
			if(_objList[i].fresh) _objList[i].fresh = false;
		}

		_update = 0;
	}

	function autoPositioning(fFlush=false){
		sortADVObjectBustupRelate();
		var nBustup = countADVObjBustup();
		var indent;
		var startX;
		switch(nBustup){
		case 1:  indent=  0; break;
		case 2:  indent=600; break;
		case 3:  indent=400; break;
		case 4:  indent=350; break;
		case 5:  indent=300; break;
		default: indent=250; break;
		}
		startX = - ((nBustup-1) * indent)/2;
		for(var i=0;i<_objList.count;i++){
			with(_objList[i]){
				if(.kind == ADVOBJ_BUSTUP && .destroy == ADVOBJ_DESTROY_NONE){
					var pos = .getWorldPos();
					if(false){
					//‚µ‚ÉEEE
						if(.fresh){
						//V‹KƒIƒuƒWƒFƒNƒg‚Ìê‡‚ÍA‚»‚Ì‚Ü‚Ü‚ÌˆÊ’u‚Éİ’è
							if(!._tempPositioning)
								.setWorldPos(startX, pos.y, pos.z);
						}else if(pos.x != startX && !fFlush){
						//Šù‘¶‚ÅˆÊ’u‚ª•ÏX‚³‚ê‚Ä‚¢‚é‚È‚çAƒAƒNƒVƒ‡ƒ“‚ÅˆÚ“®
							asyncAction(%[id:_objList[i]._info.id, action:"ActionAdvMove", x:startX]);
						}else{
							if(!._tempPositioning)
								.setWorldPos(startX, pos.y, pos.z);
						}
					}else{
						if(!._tempPositioning)
							.setWorldPos(startX, pos.y, pos.z);
					}
					._tempPositioning = false;
					startX += indent;
				}
			}
		}
	}

	//ƒAƒNƒVƒ‡ƒ“
	function asyncAction(elm){
		//–{‘Ì
		var index  = getADVObjectIndex(elm.id, true);
		//Á‚¦‚©‚¯‚Ä‚¢‚é‚à‚Ì‚ğ•ß‘¨
		var index_ = getADVObjectIndex(elm.id+"-trans", true);

		if(index != -1 || index_ != -1){
		//ADVƒIƒuƒWƒFƒNƒg
			elm.world = 1;
		}else if(elm.id == "ƒƒbƒZ[ƒW"){
			elm.target = _msg;
		}else if(elm.id == "ƒJƒƒ‰"){
			elm.target = _camera_pos;
			//ƒJƒƒ‰‚ªˆÚ“®’†‚È‚ç~‚ß‚é
			if(_fCamera_move) flushMoveCamera();
		}else if(elm.id == "ƒtƒFƒCƒX"){
			elm.target = _msg._sprFace;
		}else if(elm.id == "ƒJƒbƒgƒCƒ“"){
			elm.target = _cutin;
		}else{
			return;
		}

		elm.startTime = _actionTimeKeeper.now();
		if(elm.cycle === void)
			elm.cycle = 500;

		var fAction = false;
		if(elm.target !== void){
			_actionList.add(elm, isSkip());
			fAction = true;
		}
		if(index != -1){
			elm.target = _objList[index];
			_actionList.add(elm, isSkip());
			fAction = true;
		}
		if(index_ != -1){
			elm.target = _objList[index_];
			_actionList.add(elm, isSkip());
			fAction = true;
		}

		//ˆÚ“®ŒnƒAƒNƒVƒ‡ƒ“‚Í©“®ˆÊ’u’²®–³Œø‚ÉB
		//‚½‚¾‚µƒtƒF[ƒhƒAƒEƒgŒn‚Í–³‹
		if(elm.world !== void){
			switch(elm.action){
			case "ActionAdvMove" :
			case "ActionAdvMoveWave" :
			case "ActionAdvMoveFadeIn" :
			case "ActionAdvMoveWaveFadeIn" :
			//case "ActionAdvMoveFadeOut" :
			//case "ActionAdvMoveWaveFadeOut" :
				_fBustupAutoPositioning = false;
				break;
			}
		}

		if(fAction) startAction();
	}
	function stopAsyncAction(elm){
		var target = null;
		if(getADVObjectIndex(elm.id) != -1){
			target = _objList[getADVObjectIndex(elm.id)];
		}else if(elm.id == "ƒƒbƒZ[ƒW"){
			target = _msg;
		}else if(elm.id == "ƒJƒƒ‰"){
			target = _camera_pos;
		}else if(elm.id == "ƒtƒFƒCƒX"){
			target = _msg._sprFace;
		}else if(elm.id == "ƒJƒbƒgƒCƒ“"){
			target = _cutin;
		}

		_actionList.stopAction(target);
	}
	function flushAction(target){
		if(_actionList.isAction(target)){
			_actionList.stopAction(target);
		}
	}
	function onEndAction(target){
		if(_actionList.isAction(target) && _actionWaitTarget == target){
			_scCtrl.trigger("action_end");
			_actionWaitTarget = null;
		}
	}

	function eyeCatch(elm){
		//‰¹ŠÖŒW’â~
		StopBgm(3000);
		StopSe();
		StopEnvSe("", 3000);
		StopVoice();

		if(elm.type === void) elm.type = "";
		if(elm.char === void) elm.char = "";

		_eyeCatch = new EyeCatch(window, window.baseLayer, this, elm.type, elm.char);
	}
	function eyeCatchDelete(){
		_scCtrl.trigger("eyecatch_end");

		if(!isvalid _eyeCatch) return;
		if(_eyeCatch == null) return;

		invalidate _eyeCatch;
		_eyeCatch = null;
	}

	function messageFrame(elm){
		if(isSkip())
			elm.time = 0;
		else
			elm.time = 300;

		if(elm.type === void) elm.type = 0;
		_msg.setType(elm.type, elm.time);
	}
	function show(fade=300){
		if(!_msg.isShow() && _advHide == false){
			_msg.show(fade);

			if(_startSelect){
				for(var i=0;i<_selectBtn.count;i++)
					_selectBtn[i].btn.hitThreshold = 0;
				_selectBase.setBlendingEnvelope(255);
				_selectBase.beginActivation(300);
			}
		}
	}
	function hide(fade=300, fAdvHide=false){
		_advHide = fAdvHide;
		if(_msg.isShow()){
			_msg.hide(fade, fAdvHide);

			if(_startSelect){
				for(var i=0;i<_selectBtn.count;i++)
					_selectBtn[i].btn.hitThreshold = 256;
				_selectBase.setBlendingEnvelope(0);
				_selectBase.beginActivation(300);
			}
		}
	}
	function moveWindow(x=0, y=0){
		if(_msg.isShow() && !isSkip())
			_msg.movePos(x, y);
		else
			_msg.movePos(x, y, 0);

		_msgX = x;
		_msgY = y;
	}

	function isShow(){
		return _msg.isShow();
	}

	function delay(elm){
	//elm.time
		if(!_update) return;
	}

	function addSelect(elm){
		var temp = %[];
		(Dictionary.assign incontextof temp)(elm);
		_select.add(temp);
	}
	function startSelect(){
		if(_select.count == 0) return;

		@if(__DEBUGMODE__)
			//PlaySe("SE036");
		@endif

		//ƒXƒLƒbƒv‰ğœİ’è‚È‚ç‰ğœ
		if(CONFIG.lockSkip == 0 && isSkip())
			skip(false);

		//ƒI[ƒg‰ğœİ’è‚È‚ç‰ğœ
		if(CONFIG.lockAuto == 0 && isAuto())
			auto(false);

		_quickSave = false;

		_startSelect = true;

		if(_fLoad){
			loadEnd(true);
		}else{
			if(_update) update();
			if(_orderList.count) processOrder();

			_hitretNum++;
		}

		var hint = %[
		¤æ¤¢ : "FRM_0132", 
		¼†Ñ© : "FRM_0133", 
		Ï¦ê– : "FRM_0134", 
		¤«¤Ê¤Ç : "FRM_0135", 
		];

		_selectBtn = [];
		for(var i=0;i<_select.count;i++){
			_selectBtn[i] = %[];
			_selectBtn[i].btn = new Button(win, _selectBase);
			with(_selectBtn[i].btn){
				.create("FRM_0131", 2);
				if(_select[i].invalid !== void) .valid = false;
			}
			if(_select[i].hint !== void){
				_selectBtn[i].hintSpr = new global.Sprite(window, _selectBtn[i].btn);
				with(_selectBtn[i].hintSpr){
					.loadImages(hint[_select[i].hint]);
					.setSize(.imageWidth, 47);
					.setPos(488, 12);
					.imageTop = -40;
					.hitThreshold = 256;

					.opacity = 0;
					.setBlendingEnvelope(255);
					.setMovingEnvelope(.left+32, .top, .left, .top, 2);
					.beginActivation(300);
					.visible = CONFIG.routeGuide;
				}
				_selectBtn[i].hintSprL = new global.Sprite(window, _selectBtn[i].btn);
				with(_selectBtn[i].hintSprL){
					.assignImages(_selectBtn[i].hintSpr);
					.setSize(.imageWidth, 47);
					.imageTop = _selectBtn[i].hintSpr.imageTop;
					.doBoxBlur(4, 0);
					.hitThreshold = 256;
				}
				_selectBtn[i].hintSprR = new global.Sprite(window, _selectBtn[i].btn);
				with(_selectBtn[i].hintSprR){
					.assignImages(_selectBtn[i].hintSpr);
					.setSize(.imageWidth, 47);
					.imageTop = _selectBtn[i].hintSpr.imageTop;
					.doBoxBlur(4, 0);
					.hitThreshold = 256;
				}
			}
			_selectBtn[i].mess = new global.Layer(win, _selectBtn[i].btn);
			with(_selectBtn[i].mess){
				.setSize(_selectBtn[i].btn.width, _selectBtn[i].btn.height);
				.font.face = ADV_FONT_MESS_FACE;
				.font.height = 32;
				.hitType = htMask;
				.hitThreshold = 256;
				var e = DEF_FONT_STYLE;
				var mx = 128;
				var my = (_selectBtn[i].btn.height - .font.height) /2;
				var text = _select[i].text;
				if(_select[i].invalid === void){
					.drawText(mx + _selectBtn[i].width * 0, my, text, e.color, e.opa, e.aa, e.shadowlevel, 0x000000, e.shadowwidth, e.shadowx, e.shadowy);
					.drawText(mx + _selectBtn[i].width * 1, my, text, e.color, e.opa, e.aa, e.shadowlevel, 0x000000, e.shadowwidth, e.shadowx, e.shadowy);
				}else{
					.drawText(mx + _selectBtn[i].width * 0, my, text, e.color, 128, e.aa, e.shadowlevel, 0x000000, e.shadowwidth, e.shadowx, e.shadowy);
					.valid = false;
				}

				.visible = true;
			}
		}

		var cx = (WINDOW_WIDTH-_selectBtn[0].btn.width)/2;
		var cy = 250 - ((_selectBtn[0].btn.height+4)*_select.count)/2;
		for(var i=0;i<_select.count;i++){
			_selectBtn[i].btn.setPos(cx, cy+(_selectBtn[i].btn.height+4)*i);
		}

		_selectBase.opacity = 0;
		_selectBase.setBlendingEnvelope(255);
		_selectBase.beginActivation(300);
		_selectBase.visible = true;
	}
	function endSelect(){
		if(!_startSelect) return;

		_selectBase.visible = false;
		_selectBase.setBlendingEnvelope(0);
		_selectBase.beginActivation(300);

		for(var i=0;i<_selectBtn.count;i++){
			if(_selectBtn[i].hintSpr !== void){
				invalidate _selectBtn[i].hintSprL;
				invalidate _selectBtn[i].hintSprR;
				invalidate _selectBtn[i].hintSpr;
			}
			invalidate _selectBtn[i].btn;
			invalidate _selectBtn[i].mess;
		}
		InvalidateArray(_selectBtn);
		_selectBtn.clear();

		_select.clear();
		_startSelect = false;
		_scCtrl.trigger("select");
	}
	function selectDepth(trans){
		for(var i=0;i<_select.count;i++){
			_selectBtn[i].btn.opacity = trans;
		}
	}
	function chkSelect(id){
		return (ret_select == id);
	}
	function chkSelectStr(strId){
		return (ret_select_str == strId);
	}
	function isSelect(){
		return _startSelect;
	}

	function blurSelectHint(id){
		if(_selectBtn[id].hintSpr === void) return;
		if(!_selectBtn[id].hintSpr.visible) return;

		if(_selectBtn[id].hintSpr.isActivation()) _selectBtn[id].hintSpr.flushActivation();

		with(_selectBtn[id].hintSpr){
			.opacity = 0;
			.setBlendingEnvelope(255);
			.beginActivation(500);
		}
		with(_selectBtn[id].hintSprL){
			.setPos(_selectBtn[id].hintSpr.left, _selectBtn[id].hintSpr.top);
			.opacity = 255;
			.setBlendingEnvelope(0);
			.setMovingEnvelope(.left-8, .top, .left, .top, 2);
			.beginActivation(500);
			.visible = true;
		}
		with(_selectBtn[id].hintSprR){
			.setPos(_selectBtn[id].hintSpr.left, _selectBtn[id].hintSpr.top);
			.opacity = 255;
			.setBlendingEnvelope(0);
			.setMovingEnvelope(.left-8, .top, .left, .top, 2);
			.beginActivation(500);
			.visible = true;
		}
	}

	function initParam(){
		clearParam();
	}
	function clearParam(id=0, num=-1){
		_param.clear(id,num);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function getParam(id){
		return _param.get(id);
	}
	function setParam(id, arg){
		_param.set(id, arg);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function addParam(id, arg){
		_param.set(id, _param.get(id)+arg);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function onFlag(id){
		_param.set(id, 1);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function offFlag(id){
		_param.set(id, 0);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function chkFlagOn(id){
		return (_param.get(id) != 0);
	}
	function chkFlagOff(id){
		return (_param.get(id) == 0);
	}
	function onGlobalFlag(id){
		SetGlobalFlag(id, true);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}
	function offGlobalFlag(id){
		SetGlobalFlag(id, false);
		@if(__DEBUGMODE__)
			debug.paramUpdate();
		@endif
	}

	function playBgm(elm){
	//elm.file
	//elm.fade
	//elm.pos
	//elm.loop
		var fade, pos, loop;
		if(elm.nonfade !== void)
			fade = 0;
		else if(elm.fade === void)
			fade = 1000;
		else
			fade = elm.fade;

		if(elm.pos === void){}

		PlayBgm(elm.file, fade);
	}

	function stopBgm(elm){
	//elm.fade
		var fade;
		if(elm.nonfade !== void)
			fade = 0;
		else if(elm.fade === void)
			fade = 1000;
		else
			fade = elm.fade;

		StopBgm(fade);
	}

	function pauseBgm(){
		PauseBgm();
	}
	function restartBgm(){
		RestartBgm();
	}

	function playSe(elm){
		var vol=1.0, pan=0;
		if(elm.vol !== void) vol = int(elm.vol);
		if(elm.pan !== void) pan = int(elm.pan);
		PlaySe(elm.file, vol, pan);
	}

	function stopSe(elm=%[]){
		var id = "";
		if(elm.id !== void) id = int elm.id;
		var fade = 0;
		if(elm.fade !== void) fade = int elm.fade;
		else fade = 1000;
		StopSe(id, fade);
	}

	function waitSe(elm){
	}

	function playEnvSe(elm=%[]){
	//elm.file
	//elm.fade
	//elm.playID
		var fade;
		if(elm.nonfade !== void)
			fade = 0;
		else if(elm.fade === void)
			fade = 1000;
		else
			fade = elm.fade;

		var vol=1.0, pan=0;
		if(elm.vol !== void) vol = int(elm.vol);
		if(elm.pan !== void) pan = int(elm.pan);

		PlayEnvSe(elm.file, vol, pan, fade);
	}

	function stopEnvSe(elm=%[]){
	//elm.fade
	//elm.playID
		var id, fade;
		if(elm.id === void)
			id = "";
		else
			id = elm.id;

		if(elm.nonfade !== void)
			fade = 0;
		else if(elm.fade === void)
			fade = 1000;
		else
			fade = elm.fade;

		StopEnvSe(id, fade);
	}

	function playVoice(voice, pan, fConfig=true){
		_fPlayVoice = false;
		_fPlayedVoice = false;

		if(voice == "") return;

		_fPlayVoice = true;

		if(voice === void) voice = "";
		if(pan === void) pan = "";

		var voices = voice.split("/");
		var pans = pan.split("/");

		stopVoice();

		for(var i=0;i<voices.count;i++){
			var header = voices[i].substring(0, 2);
			if(CheckPlayVoice(header) || !fConfig){
				var pan = 0;
				if(pans.count > i) pan = int(pans[i]);
				var vol = 1.0;
				if(HEADER_TO_ID[header] !== void)
					vol = CONFIG.voiceDetails[HEADER_TO_ID[header]].volume;

				if(!isSkip())
					PlayVoice(voices[i], vol, pan, fConfig);

				_fPlayedVoice = true;
			}
		}

		@if(__DEBUGMODE__)
			if(_fPlayedVoice){
				_msg.playVoice();
			}
		@endif
	}

	function repeatVoice(elm, fConfig=true){
	//elm.file
	//elm.id
		_fPlayVoice = false;
		stopVoice();
		var vol = 1.0;
		if(HEADER_TO_ID[header] !== void)
			vol = CONFIG.voiceDetails[HEADER_TO_ID[header]].volume;
		PlayVoice(elm.file, vol, 0, fConfig);
	}

	function stopVoice(elm=%[]){
		var fade = 0;
		if(elm.fade !== void) fade = int elm.fade;
		StopVoice(fade);
	}

	function transition(elm){
	//elm.style
	//elm.time
	//elm.rule
	}

	function blackOut(elm=%[]){
	//elm.time
		elm.tagname = "cg";
		elm.file = "BLACK";
		addOrderList(elm);
		_update |= UPDATE_CG;
		update(elm);
	}

	function whiteOut(elm=%[]){
	//elm.time
		elm.tagname = "cg";
		elm.file = "WHITE";
		addOrderList(elm);
		_update |= UPDATE_CG;
		update(elm);
	}

	function colorOut(elm=%[]){
	//elm.col
	//elm.time
		elm.tagname = "cg";
		elm.file = "";
		addOrderList(elm);
		_update |= UPDATE_CG;
		update(elm);
	}

	function wait(elm){
	//elm.time
	}

	function waitBgm(){
	}

	function waitSe(){
	}

	function waitVoice(){
	}

	function waitEnvSe(){
	}

	function waitTransition(){
	}

	function skip(f, fClick=true){
	//fClick : ƒXƒLƒbƒv‚ªƒIƒ“‚É‚È‚Á‚½‚Æ‚«‚Éˆê“xƒNƒŠƒbƒN‚ğ”­¶‚³‚¹‚é
		if(!isShow()) return;

		_msg.skip = (f!=false);	//ƒƒbƒZ[ƒWƒXƒŒ[ƒ€‚É’Ê’m
		if(f && fClick){ click(); }
	}

	function isSkip(mode = false){
		if(mode)	//ƒXƒLƒbƒvƒ‚[ƒh‚Ì‚İ‚Ìƒ`ƒFƒbƒN
			return (_msg.skip);
		else		//CtrlƒL[‰Ÿ‰º‚ğ‡‚í‚¹‚½ƒ`ƒFƒbƒN
			return ((_shift&ssCtrl && window.activate) || _msg.skip);
	}

	function searchSkip(strSearch){
	//ƒfƒoƒbƒO—p‚ÌƒT[ƒ`ƒXƒLƒbƒv
		_strSearch = strSearch;
		skip(true);
	}

	function auto(f, fSys=false){
		if(!isShow() && !fSys) return;

		_msg.auto = (f!=false);	//ƒƒbƒZ[ƒWƒXƒŒ[ƒ€‚É’Ê’m

		var fVoice = VOICE.isPlay();

		fVoice &= _fPlayedVoice;

		if(f && !fVoice){
		//ƒIƒ“@‰¹º‚ªÄ¶‚³‚ê‚Ä‚¢‚È‚¢
		//ƒNƒŠƒbƒN
			click();
		}else if(f && fVoice){
		//ƒIƒ“@‰¹º‚ª‚³‚ê‚Ä‚¢‚é
		//‚È‚É‚à‚µ‚È‚¢
		}else{
		//ƒIƒt
		//ƒ^ƒCƒ}[ƒXƒgƒbƒv
			stopAutoTimer();
		}
	}
	function isAuto(){
		return _msg.auto;
	}
	function onAutoCallback(now){
		if(_msg.isPending() && !_fPlayVoice){
			_autoTimer.interval = 100;
		}else{
			if(_msg.isPending()) _msg.flush();
			click();
			stopAutoTimer();
		}
	}

	function isTransition(){
		var ret = false;

		if(_sprTrans.isTransition()) ret = true;

/*
		for(var i=_objList.count-1;i>=0;i--){
			if(_objList[i].isTransition()) ret = true;
			if(_objList[i].isActivation()) ret = true;
		}
*/

		return ret;
	}

	function isRecollect(){
		return _fRecollect;
	}

	function change(sc, label=""){
		@if(__DEBUGMODE__)
			win.caption = global.GAME_CAPTION + " : " + sc;
		@endif
		_scenario = sc;
		if(!_fLoad){
			_logSelect.clear();
			_hitretNum = 0;
		}
		_paramPrev.object().assign(_param.object());
		_scCtrl.clear();
		_scCtrl.scenarioLoop(sc, label);
	}

	function returnTo(scene){
		game.changeScene(scene, true);

		//‰¹ŠÖŒW’â~
		StopBgm(1000);
		StopSe("", 1000);
		StopEnvSe("", 1000);
		StopVoice(1000);
		endSelect();
		hide(300, true);

		_end=true;
		var temp = CONFIG.screenEffect;
		CONFIG.screenEffect = 1;		//‹­§ƒIƒ“
		blackOut(%[time:2000]);
		CONFIG.screenEffect = temp;

		//ƒVƒiƒŠƒI~‚ß‚é
		_scCtrl.interrupt = true;
	}

	//‰æ–Ê‚ÌƒRƒs[‚ğì¬‚·‚é
	function screenShot(spr, fFrame=true){
		spr.setSize(WINDOW_WIDTH, WINDOW_HEIGHT);

		var fVisibleMsg = _msg.visible;

		var fVisibleMsgQSaveInfo = _msg._sprQSaveInfo.visible;
		_msg._sprQSaveInfo.visible = false;

		var fVisibleInfo;
		if(SPR_INFORMATION != null){
			fVisibleInfo = SPR_INFORMATION.visible;
			SPR_INFORMATION.visible = false;
		}
		var fVisibleConfirm;
		if(SPR_CONFIRM != null){
			fVisibleConfirm = SPR_CONFIRM.visible;
			SPR_CONFIRM.visible = false;
		}

		if(fFrame == false){
			_msg.visible = false;
		}

		window.baseLayer.hasImage = true;
		spr.piledCopy(0, 0, window.baseLayer, 0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);
		window.baseLayer.hasImage = false;

		_msg.visible = fVisibleMsg;
		_msg._sprQSaveInfo.visible = fVisibleMsgQSaveInfo;
		if(SPR_INFORMATION != null)
			SPR_INFORMATION.visible = fVisibleInfo;
		if(SPR_CONFIRM != null)
			SPR_CONFIRM.visible = fVisibleConfirm;
	}

	//ƒ[ƒhˆ—
	//è‡F‰æ–Ê‰B‚·¨•œ‹Aƒ|ƒCƒ“ƒg‚Ü‚ÅˆÚ“®¨‰æ–Ê\’z¨‰æ–Ê•\¦
	function load(filename=""){
		if(_fRecollect) return;

		_saveData = new Savedata();
		if(_saveData.load(filename) == false) return;

		//ƒVƒiƒŠƒI’â~
		_scCtrl.wait(%[]);

		_fLoad = true;
		_hitretState = false;

		//‰¹ŠÖŒW’â~
		StopBgm();
		StopSe();
		StopEnvSe();
		StopVoice();

		if(IsPlayMovie())
			onStopMovie();

		if(IsStaffRoll())
			StaffRollDelete();

		BeginLoad(this.loadStart);	//ƒ[ƒhˆ—ŠJnBŒ»İ‚Ì‰æ–Ê‚ğ‰B‚·B
	}

	function loadStart(){
		if(_startSelect) endSelect();

		if(isSkip()) skip(false);
		if(isAuto()) auto(false);

		hide(0, true);

		_actionList.stopAction(_cutin);
		cutin(%[hide:1]);

		if(_fAction)
			flushMoveCamera();

		if(_eyeCatch != null) _eyeCatch.close();

		//BGM
		if(_saveData.param.bgm != "")
			playBgm(%[file:_saveData.param.bgm]);
			if(_saveData.param.pauseBgm) pauseBgm();

		//ŠÂ‹«‰¹
		var ref = _saveData.param.envSe;
		for(var i=0;i<_saveData.param.envSe.count;i++){
			playEnvSe(ref[i]);
		}

		//ƒVƒiƒŠƒI‚ğ’ÇÕ‚·‚é‚½‚ß‚ÉA
		//ƒZ[ƒuƒf[ƒ^‚ÌŠeƒpƒ‰ƒ[ƒ^‚ğƒIƒuƒWƒFƒNƒg‚É”½‰f
		_saveData.applyToAdv(this);

		_hitretCnt = _saveData.param.hitret - 1;
		_selectCnt = 0;

		start(_saveData.param.scenario);	//ƒVƒiƒŠƒI‚ğ•œ‹Aƒ|ƒCƒ“ƒg‚Ü‚ÅˆÚ“®‚³‚¹‚éB
	}

	function loadEnd(){
	//•œ‹Aƒ|ƒCƒ“ƒg‚É“’B‚µ‚½‚Ì‚ÅADV‰æ–Ê‚ğ\’z‚·‚éB
		//--------------------------------------------------------------------------
		//ƒƒbƒZ[ƒWE‰¹º
		var index = _logName.count-1;
		_name = _logName[index];
		_mess = _logMess[index];
		_voice = _logVoice[index];
		_pan = _logParam[index].pan;
		_fFont = true;
		(Dictionary.assign incontextof _fontElm)(_logParam[index].font);
		@if(__DEBUGMODE__)
			if(debug.tglFont.state) _fontElm.face = ADV_FONT_MESS_FACE;
		@endif

		_face = _saveData.param.face;

		if(_startSelect){
		//‘I‘ğˆ’†‚Ì•œ‹A‚Ìê‡‚Í‚±‚±‚ÅƒƒbƒZ[ƒW‚ğo—Í‚µ‚Ä‚¨‚­B
			var name = _name.split("/");
			var dispName;
			if(name.count == 1){
				dispName = name[0];
			}else{
				dispName = name[1];
			}
			outputMessage(dispName, _mess, _voice, _pan, true);
			_advHide = false;
			show(0);
		}

		_msg.setType(_saveData.param.messageFrame);
		_msgX = _saveData.param.messageX;
		_msgY = _saveData.param.messageY;
		_msg.movePos(_msgX, _msgY, 0);

		//‚b‚f
		clearChar();
		for(var i=0;i<_saveData.param.advObject.count;i++){
			var file = _saveData.param.advObject[i].file;
			var id = _saveData.param.advObject[i].id;
			var order = _saveData.param.advObject[i].order;
			var zOrder = _saveData.param.advObject[i].zOrder;
			var relate = _saveData.param.advObject[i].relate;
			var center = _saveData.param.advObject[i].center;
			var world = _saveData.param.advObject[i].worldPos;
			var base = _saveData.param.advObject[i].basePos;
			var focus = _saveData.param.advObject[i].focus;
			var tone = _saveData.param.advObject[i].tone;
			var opacity = _saveData.param.advObject[i].opacity;
			var flipLR = _saveData.param.advObject[i].flipLR;
			var flipUD = _saveData.param.advObject[i].flipUD;

			var param = %[file:file, id:id, wpos:world, order:order, time:0, focus:focus, tone:tone, trans:opacity];
			if(flipLR) param.fliplr = 1;
			if(flipUD) param.flipud = 1;

			switch(_saveData.param.advObject[i].kind){
			case ADVOBJ_CG:		cg(param); break;
			case ADVOBJ_BUSTUP: char(param); break;
			case ADVOBJ_SCREEN: break;
			}
		}
		//ƒJƒbƒgƒCƒ“
		if(_saveData.param.cutin.file != "")
			cutin(_saveData.param.cutin);

		//ƒJƒƒ‰
		if(_saveData.param.camera_move == ""){
			moveCamera(%[pos:_saveData.param.camera, time:0]);
		}else{
			moveCamera(%[pos:_saveData.param.camera_move, time:0]);
		}

		//ƒ[ƒh•œ‹A‚Í©“®ˆÊ’u’²®‚ª‚n‚m‚Å‚ ‚Á‚Ä‚à
		//ƒZ[ƒuƒf[ƒ^‚Éw’è‚³‚ê‚Ä‚¢‚éÀ•W‚ÅƒoƒXƒgƒAƒbƒv‚ğ•\¦‚³‚¹‚é
		_fBustupAutoPositioning = false;
		_fBustupRelateFlip = false;

		//--------------------------------------------------------------------------
		//‰æ–ÊXV
		update(%[flush:1]);
		//--------------------------------------------------------------------------

		//©“®ˆÊ’u’²®İ’è‚ğ”½‰f
		_fBustupAutoPositioning = _saveData.param.autoPosition;

		//ƒJƒƒ‰ˆÚ“®
		if(_saveData.param.camera_move != ""){
			moveCamera(%[pos:_saveData.param.camera, time:_saveData.param.camera_move_time]);
		}

		//ƒAƒNƒVƒ‡ƒ“
		for(var i=0;i<_saveData.param.action.count;i++){
			var elm = _saveData.param.action[i];
			delete elm.target;		//•K—v‚È‚¢‚Ì‚Åíœ
			asyncAction(elm);
		}

		//ADV‰æ–Ê‚Ì\’z‚ªI—¹‚µ‚½‚Ì‚ÅA‰B‚µ‚Ä‚¢‚½‰æ–Ê‚ğ•\¦‚·‚éB
		EndLoad();

		_fLoad = false;

		invalidate _saveData;
		_saveData = null;
	}

	function quickLoad(){
		if(_end) return;
		if(!_hitretState) return;
		if(_fRecollect) return;
		if(IsLoadProccesing()) return;

		var temp = saveMan.atQSave();
		if(temp.valid){
			if(isAuto()) auto(false);
			if(isSkip()) skip(false);

			if(CONFIG.confirmWindow[SystemRegister.CONFIRM_LOAD])
				PlaySystemVoice("‚pƒ[ƒhŠm”F");
			CallConfirm("$c:cyan,blue;¿ìËÙ¶ÁÈ¡$c;È·ÈÏ£¿", SystemRegister.CONFIRM_LOAD, quickLoadRun, null);
		}
	}
	function quickLoadRun(){
		load("qsave.dat");
		dm("ƒNƒCƒbƒNƒ[ƒh‚µ‚Ü‚·");
	}

	function quickSave(){
		if(_end) return;
		if(_fRecollect) return;

		//hitret‘Ò‚¿ó‘Ô‚¶‚á‚È‚¢‚ÆƒZ[ƒu‚Å‚«‚È‚¢
		if(!_hitretState) return;

		//ˆê“x‚µ‚©ƒNƒCƒbƒNƒZ[ƒu‚Å‚«‚È‚¢iƒ{ƒ^ƒ“˜A‘Å‘Îôj
		if(_quickSave) return;
		_quickSave = true;

		//ƒAƒNƒVƒ‡ƒ“ƒ^ƒCƒ}‚Ìˆê’â~
		pauseAction();

		var save = new Savedata();
		save.save("qsave.dat", -1, this);
		invalidate save;

		//ƒAƒNƒVƒ‡ƒ“ƒ^ƒCƒ}‚ÌÄŠJ
		restartAction();

		dm("ƒNƒCƒbƒNƒZ[ƒu‚µ‚Ü‚µ‚½");
		PlaySystemVoice("‚pƒZ[ƒuÀs");
		Information("$c:cyan,blue;¿ìËÙ´æµµ$c;Íê³É");

		_msg.refreshQSaveInfo();
	}

	function close(){
		stopAction();
		_msg.interupt = true;

		//‰¹ŠÖŒW’â~
		StopBgm();
		StopSe();
		StopEnvSe();
		StopVoice();

		valid = false;						//ƒV[ƒ“ƒIƒuƒWƒFƒNƒg–³Œø‰»
	}

	function playMovie(elm){
		//ƒI[ƒgAƒXƒLƒbƒv‹­§ƒXƒgƒbƒv
		_msg.auto = false;
		_msg.skip = false;

		//‰¹ŠÖŒW’â~
		StopBgm();
		StopSe();
		StopEnvSe();
		StopVoice();

		//ADVScreen”ñ•\¦
		visible = false;

		if(_sprTrans.isTransition()){
		//‚Ü‚¾‘O‚Ìƒgƒ‰ƒ“ƒWƒbƒVƒ‡ƒ“‚ªI—¹‚µ‚Ä‚¢‚È‚¢‚È‚çI—¹‚³‚¹‚éB
			transitionComplete(_sprTrans);
		}

		hide(0, true);

		PlayMovie(elm.file, this);

		_fMovie = true;
	}
	function onStopMovie(){
		StopMovie();
		visible = true;
		_fMovie = false;
	}

	function staffroll(elm){
		CallStaffRoll(elm.id, this);
	}

	function callSystemWindow(type){
		if(!_msg.isShow()) return;
		if(_fMovie) return;
		if(_eyeCatch != null) return;
		if(IsStaffRoll()) return;

		if(isSkip()) skip(false);
		if(isAuto()) auto(false);

		if(!_startSelect && (isSkip() || isAuto())) return;

		if(!_hitretState) return;

		switch(type){
		case SYSWIN_CONFIG : 
			callConfig();
			break;
		case SYSWIN_HISTORY : 
			callHistory();
			break;
		case SYSWIN_LOAD : 
			callLoad();
			break;
		case SYSWIN_SAVE : 
			callSave();
			break;
		}
	}

	function callConfig(){
		var returnMenu = _fRecollect?2:1;
		CallConfig(this, returnMenu, 1);
	}
	function callHistory(){
		CallHistory(this);
	}
	function callLoad(){
		if(_fRecollect) return;

		CallLoadSave(true);
	}
	function callSave(){
		if(_fRecollect) return;

		CallLoadSave(false, this);
	}

	property hitretState{
		getter(){return _hitretState;}
	}

	property interrupt{
		setter(v){
			_scCtrl.interrupt = v;
			_msg.interrupt = v;
			if(v){
			//’â~
				if(_fAction){pauseAction();}
			}else{
			//ÄŠJ
				if(!_fAction){restartAction();}
			}
		}
		getter(){return _scCtrl.interrupt;}
	}
}

ADVScreen.SYSWIN_CONFIG		= 1;
ADVScreen.SYSWIN_HISTORY	= 2;
ADVScreen.SYSWIN_LOAD		= 3;
ADVScreen.SYSWIN_SAVE		= 4;

class Savedata{
	var _valid;
	var _param;

	function Savedata(filename=""){
		_param = %[];

		init();

		_valid = false;

		if(filename != "")
			load(filename);
	}
	function finalize(){
		invalidate _param;
	}

	function init(){
		with(_param){
			.save = 0;						//ƒZ[ƒu‚³‚ê‚Ä‚¢‚é‚©‚Ç‚¤‚©

			.title = GAME_TITLE;
			.version = GAME_VERSION;
			.save_version = SAVE_VERSION;

			.save_date = "";

			//ƒVƒiƒŠƒIƒtƒ@ƒCƒ‹–¼
			.scenario = "";
			//ƒV[ƒ“ƒ^ƒCƒgƒ‹
			.scene = "";
			//hitret‰ñ”
			.hitret = 0;
			//‘I‘ğˆî•ñ
			.select = [];
			//ƒpƒ‰ƒ[ƒ^
			.param = [];
			//“ú•t
			.month = 0;
			.day = 0;
			//ƒLƒƒƒ‰ƒ‹[ƒg
			.root = 0;

			//ƒƒbƒZ[ƒWƒtƒŒ[ƒ€
			.messageFrame = 0;
			.messageX = 0;
			.messageY = 0;
			//ƒtƒFƒCƒX
			.face = "";

			//ƒJƒbƒgƒCƒ“
			.cutin = %[];

			//ƒƒbƒZ[ƒWE“ú•tEƒ‹[ƒv•\¦‚ÌƒVƒiƒŠƒIw’èÁ‹
			.advDateHide = 0;

			//ƒoƒbƒNƒƒO
			.logName = [];
			.logMess = [];
			.logVoice = [];
			.logParam = [];

			//ADVƒIƒuƒWƒFƒNƒg
			.advObject = [];
			.autoPosition = true;
			//ƒJƒƒ‰
			.camera = PointNumToStr(0,0,0);
			.camera_move = "";
			.camera_move_time = 0;

			//ƒtƒ‰ƒbƒVƒ…
			.flash = "";

			//ƒAƒNƒVƒ‡ƒ“
			.action = [];

			//‰¹Šy
			.bgm = "";
			.pauseBgm = 0;
			//ŠÂ‹«‰¹
			.envSe = [];
		}
	}

	function set(adv){
		with(_param){

			//ƒZ[ƒu‚µ‚½‚±‚Æ‚É‚·‚é
			.save = 1;

			//-----------------------------------------------------------------
			//ƒVƒiƒŠƒIƒtƒ@ƒCƒ‹–¼
			.scenario = adv._scenario;
			//ƒV[ƒ“ƒ^ƒCƒgƒ‹
			.scene = adv._scene;
			//hitret‰ñ”
			.hitret = adv._hitretNum;
			//‘I‘ğˆî•ñ
			.select.assign(adv._logSelect);
			//ƒpƒ‰ƒ[ƒ^(ƒVƒiƒŠƒIæ“ª‚Å‚Ìƒpƒ‰ƒ[ƒ^ó‘Ô)
			.param.assign(adv._paramPrev.object());
			//ƒLƒƒƒ‰ƒ‹[ƒg
			.root = adv._param.get(551);

			(Dictionary.assign incontextof .cutin)(adv._cutinParam);

			//ƒƒbƒZ[ƒWƒtƒŒ[ƒ€
			.messageFrame = adv._msg._type;
			.messageX = adv._msgX;
			.messageY = adv._msgY;
			.face = adv._face;
//			.face = adv._msg._face._prevFace;

			//ƒoƒbƒNƒƒO
			.logName.assign(adv._logName);
			.logMess.assign(adv._logMess);
			.logVoice.assign(adv._logVoice);
			.logParam.assign(adv._logParam);

			//ADVƒIƒuƒWƒFƒNƒg
			var index = 0;
			for(var i=0;i<adv._objList.count;i++){
				//íœ—\’è‚ÌƒIƒuƒWƒFƒNƒg‚Í–³‹
				if(adv._objList[i]._destroy != ADVOBJ_DESTROY_NONE) continue;

				.advObject[index] = %[];
				//ƒIƒuƒWƒFƒNƒgƒ^ƒCƒv
				.advObject[index].kind = adv._objList[i]._info.kind;
				.advObject[index].id = adv._objList[i]._info.id;
				.advObject[index].file = adv._objList[i]._info.file;
				.advObject[index].order = adv._objList[i]._info.order;
				.advObject[index].zOrder = adv._objList[i]._info.zOrder;
				.advObject[index].relate = adv._objList[i]._info.relate;
				.advObject[index].opacity = adv._objList[i].opacity;
				.advObject[index].rotate = adv._objList[i].rotate;
				.advObject[index].focus = adv._objList[i]._focus;
				.advObject[index].tone = adv._objList[i]._tone;
				.advObject[index].flipLR = adv._objList[i]._flipLR;
				.advObject[index].flipUD = adv._objList[i]._flipUD;
				var pos = adv._objList[i]._info.center;
				.advObject[index].center = PointNumToStr(pos.x, pos.y, pos.z);
				if(adv._objList[i].isBlendingActivation()){
				//ƒIƒuƒWƒFƒNƒg‚ªƒuƒŒƒ“ƒfƒBƒ“ƒOƒAƒNƒeƒBƒx[ƒVƒ‡ƒ“’†
					.advObject[index].opacity = adv._objList[i]._endOpacity;
				}
				if(adv._actionList.isAction(adv._objList[i])){
				//ƒIƒuƒWƒFƒNƒg‚ªƒAƒNƒVƒ‡ƒ“’†‚Ì‚ÍAˆÚ“®Š®—¹‚ÌÀ•W‚ğB
					pos = adv._actionList.sequence(adv._objList[i])._world;
				}else{
				//“®‚¢‚Ä‚È‚¢‚È‚ç‚»‚Ì‚Ü‚Ü‚ÌÀ•W‚ğB
					pos = adv._objList[i]._worldPos;
				}
				.advObject[index].worldPos = PointNumToStr(pos.x, pos.y, pos.z);
				pos = adv._objList[i]._basePos;
				.advObject[index].baseBase = PointNumToStr(pos.x, pos.y, pos.z);
				index++;
			}
			.autoPosition = adv._fBustupAutoPositioning;

			//ƒJƒƒ‰ˆÊ’u(•â³‚µ‚Ä‚¨‚­)
			var pos = new Point();
			var scale;
			if(adv._fAction && adv._fCamera_move){
				pos.set(adv._camera_move._end.x, adv._camera_move._end.y, adv._camera_move._end.z);
				;scale = 2.0 * (1.0 + ((pos.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
				scale = 2.0;
				pos.x /= scale;
				pos.y /= scale;
				pos.z += BG_RANGE_MAX;
				.camera = PointNumToStr(pos.x, pos.y, pos.z);

				pos.set(adv._camera_move._start.x, adv._camera_move._start.y, adv._camera_move._start.z);
				scale = 2.0 * (1.0 + ((pos.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
				pos.x /= scale;
				pos.y /= scale;
				pos.z += BG_RANGE_MAX;
				.camera_move = PointNumToStr(pos.x, pos.y, pos.z);

				.camera_move_time = adv._camera_move_time;
			}else{
				pos.set(adv._camera_pos);
				//scale = 2.0 * (1.0 + ((pos.z+BG_RANGE_MAX)) / BG_RANGE_MAX);
				scale = 2.0;
				pos.x /= scale;
				pos.y /= scale;
				pos.z += BG_RANGE_MAX;
				.camera = PointNumToStr(pos.x, pos.y, pos.z);
			}

			//ƒAƒNƒVƒ‡ƒ“
			var index = 0;
			for(var i=0;i<adv._actionList.count;i++){
				.action[index] = %[];
				if(adv._actionList._list[i]._world != void){
				//_world‚ª—LŒø‚È‚çADVObj
					if(adv._actionList._list[i]._target.destroy == ADVOBJ_DESTROY_NONE){
						(Dictionary.assign incontextof .action[index++])(adv._actionList._list[i]._elm);
					}
				}else{
					(Dictionary.assign incontextof .action[index++])(adv._actionList._list[i]._elm);
				}
			}

			//‰¹Šy
			if(BGM.isPlay("", false)){
				var obj = BGM.objectOfId("BGM_1", false);
				if(obj != -1){
					.bgm = obj._file;
					.pauseBgm = obj.paused;
				}
				obj = BGM.objectOfId("BGM_2", false);
				if(obj != -1){
					.bgm = obj._file;
					.pauseBgm = obj.paused;
				}
			}
			//ŠÂ‹«‰¹
			.envSe.assign(ENVSE.idList(false));
		}
	}

	function isExist(filename){
		if(Storages.isExistentStorage(DATA_PATH + filename)){
		//ƒZ[ƒuƒtƒHƒ‹ƒ_“àƒ`ƒFƒbƒN
			return true;
		}else if(Storages.isExistentStorage(filename)){
		//filename‚ğƒtƒ‹ƒpƒX‚Æ‚µ‚Äƒ`ƒFƒbƒN
			return true;
		}else{
			return false;
		}
	}

	function load(filename){
		var now = System.getTickCount();

		_valid = false;

		var path;
		if(Storages.isExistentStorage(DATA_PATH + filename)){
		//ƒZ[ƒuƒtƒHƒ‹ƒ_“àƒ`ƒFƒbƒN
			path = DATA_PATH;
		}else if(Storages.isExistentStorage(filename)){
		//filename‚ğƒtƒ‹ƒpƒX‚Æ‚µ‚Äƒ`ƒFƒbƒN
			path = "";
		}else{
			dm("ƒZ[ƒuƒf[ƒ^‚ªŒ©‚Â‚©‚è‚Ü‚¹‚ñ : " + filename);
			return false;
		}

		var temp;
		try{
			temp = Scripts.evalStorage(path + filename);
		}catch{
			dm("001.ƒZ[ƒuƒf[ƒ^‚ª•s³‚Å‚· : " + filename);
			return false;
		}

		var succes = true;
		//ƒZ[ƒuƒf[ƒ^‚Å‚ ‚é‚©ƒ`ƒFƒbƒN
		if(typeof temp[0] != "Object"){
		//Objectƒ^ƒCƒv‚ª‚Ç‚¤‚©ƒ`ƒFƒbƒN
			succes = false;
		}else if(temp[0].title !== void && temp[0].version !== void){
		//“Ç‚İ‚ñ‚¾ƒf[ƒ^‚Étitle,versionƒ^ƒO‚ª‚ ‚é‚©ƒ`ƒFƒbƒN
			//if(temp[0].title != GAME_TITLE){
			//ƒ^ƒCƒgƒ‹–¼‚ğƒ`ƒFƒbƒN
			//	succes = false;
			//	dm("002.ƒZ[ƒuƒf[ƒ^‚ª•s³‚Å‚· : " + filename);
			//}
			if(real(temp[0].save_version) != real(SAVE_VERSION)){
			//ƒo[ƒWƒ‡ƒ“‚ğƒ`ƒFƒbƒN
				succes = false;
				dm("003.ƒZ[ƒuƒf[ƒ^‚ª•s³‚Å‚· : " + filename);
			}
		}else{
			succes = false;
			dm("004.ƒZ[ƒuƒf[ƒ^‚ª•s³‚Å‚· : " + filename);
		}

		if(succes == false){
			return false;
		}

		if(temp[0].save == 0){
		//ƒZ[ƒu‚³‚ê‚Ä‚¢‚È‚¢ƒf[ƒ^‚¾‚¯‚ÇA’†g‚Í³í
			_valid = false;		//ƒZ[ƒu‚³‚ê‚Ä‚¢‚È‚¢ƒtƒ@ƒCƒ‹‚Í–³Œøˆµ‚¢
			return true;
		}

		_valid = true;

		//“Ç‚İ‚ñ‚¾ƒf[ƒ^‚ğƒRƒs[
		(Dictionary.assign incontextof _param)(temp[0]);

		@if(__DEBUGMODE__)
			dm("ƒ[ƒhˆ—‚É"+(System.getTickCount() - now) + "ms‚©‚©‚è‚Ü‚µ‚½");
		@endif

		return true;
	}

	function save(filename, index=-1, adv=null, init=false){
		var now = System.getTickCount();

		var temp = [];
		temp[0] = _param;

		if(adv != null) set(adv);

		@if(__DEBUGMODE__)
			var fDebugVisible = debug.visible;
			debug.visible = false;
		@endif

		//Œ»İ‚ÌŠÔ‚ğİ’è
		var date = new Date();
		_param.save_date = "%04d/%02d/%02d %02d:%02d:%02d".sprintf(date.getYear(), date.getMonth()+1, date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
		invalidate date;

		//ƒf[ƒ^ƒZ[ƒu
		//=============================================================
		@if(__FILE_CRYPT__ == 0)
			temp.saveStruct(DATA_PATH + filename);
		@endif
		@if(__FILE_CRYPT__ == 1)
			temp.saveStruct(DATA_PATH + filename, "z");
		@endif

		//ƒTƒ€ƒl[ƒ‹ƒZ[ƒu
		//=============================================================
		if(adv != null){
			var sprThumb = new global.Layer(win, win.baseLayer);
			var obj = adv.getADVObjectObject("”wŒi");
			var file = obj.info.file.substring(0, 6);
			if(CG_HSCENE_LIST[file] === void){
			//’Êí”wŒi‚©’ÊíƒCƒxƒ“ƒg
				var spr = new global.Layer(win, win.baseLayer);
				adv.screenShot(spr, true);

				var thumbW = 256;
				var thumbH = 144;
				sprThumb.setSize(thumbW, thumbH);
				sprThumb.stretchCopy(0, 0, sprThumb.width, sprThumb.height, spr, 0, 0, spr.width, spr.height, stCubic);
				invalidate spr;
			}else{
			//‚gƒV[ƒ“
				file += "TL.png";
				if(Storages.isExistentStorage(file))
					sprThumb.loadImages(file);
				else
					sprThumb.setSize(256, 144);
				sprThumb.setSizeToImageSize();

				var tone = TONE_DIC[obj._tone];
				if(tone !== void){
					if(tone[3]) sprThumb.doGrayScale();
					sprThumb.adjustGamma(
						tone[0][0], tone[0][1], tone[0][2],
						tone[1][0], tone[1][1], tone[1][2],
						tone[2][0], tone[2][1], tone[2][2]
					);
				}
			}
			sprThumb.saveLayerImage(DATA_PATH + filename.split(".")[0] + ".bmp");
			invalidate sprThumb;
		}

		//ŠÇ—ƒtƒ@ƒCƒ‹‚É‚àƒwƒbƒ_î•ñ‚ğ•Û‘¶
		//=============================================================
		//ƒZ[ƒuî•ñì¬
			var name = "";
			var mess = "";
			if(adv != null){
				var logIndex = adv._logName.count-1;
				name = adv._logName[logIndex];
				if(name.indexOf("/") != -1) name = name.split("/")[1];
				if(name == "ĞÄÖ®Éù" || name == "ÕZ¤ê")
					name = "";

				mess = adv._logMess[logIndex];
				//‹­§‰üs•¶šE‘SŠpƒXƒy[ƒX‚ğÁ‚·
				var reg1 = new RegExp("£¯|¡¡", "g");
				mess = mess.replace(reg1, "");
				invalidate reg1;
				//§ŒäƒR[ƒh‚ğÁ‚·
				var ma = new MessageArea(adv.window, adv);
				name = ma.extractOutputString(name);
				mess = ma.extractOutputString(mess);
				invalidate ma;
			}
		//=============================================================
		if(index != -1){
		//’ÊíƒZ[ƒu
			if(!init){
				saveMan.set(index, "", _param.save_date, name + mess);
			}else{
				saveMan.reset(index);
			}
		}else{
		//QSave
			if(!init){
				saveMan.setQSave("", _param.save_date, name + mess);
			}else{
				saveMan.resetQSave();
			}
		}
		saveMan.save();

		@if(__DEBUGMODE__)
			debug.visible = fDebugVisible;
			dm("ƒZ[ƒuˆ—‚É"+(System.getTickCount() - now) + "ms‚©‚©‚è‚Ü‚µ‚½");
		@endif
	}

	function applyToAdv(adv){
		if(!isValid()) return;

		with(_param){
			adv._scenario = .scenario;
			adv._scene = .scene;
			//hitret‰ñ”
			adv._hitretNum = .hitret;
			//‘I‘ğˆî•ñ
			adv._logSelect.assign(.select);
			//ƒpƒ‰ƒ[ƒ^(ƒVƒiƒŠƒIæ“ª‚Å‚Ìƒpƒ‰ƒ[ƒ^ó‘Ô)
			adv._param.object().assign(.param);

			//ƒoƒbƒNƒƒO
			adv._logName.assign(.logName);
			adv._logMess.assign(.logMess);
			adv._logVoice.assign(.logVoice);
			adv._logParam.assign(.logParam);
		}
	}

	//—LŒø‚ÈƒZ[ƒuƒf[ƒ^‚©
	function isValid(){
		return _valid;
	}

	property param{
		setter(v){_param = v;}
		getter(){return _param;}
	}
}

class LoadProcessScreen extends Sprite{
	var _spr = [];

	function LoadProcessScreen(win, par){
		super.Sprite(...);

		//ƒx[ƒX
		loadImages("FRM_0501");
		setSizeToImageSize();

		//ƒƒS
		_spr[0] = new global.Sprite(win, this);
		_spr[0].loadImages("FRM_0505");
		_spr[0].setSizeToImageSize();
		_spr[0].setPos(WINDOW_WIDTH-_spr[0].width-16, WINDOW_HEIGHT-_spr[0].height-16);
		_spr[0].visible = true;

		visible = true;
	}
	function finalize(){
		InvalidateArray(_spr);
		invalidate _spr;

		super.finalize();
	}
}

//ƒ[ƒhˆ—‚Ì‚½‚ß‚É‰æ–Ê‚ğ‰B‚·
var SPR_ADV_HIDE = null;
function BeginLoad(func=null){
	if(SPR_ADV_HIDE != null){
		if(!SPR_ADV_HIDE.isActivation() && func != null){
			func();
		}else if(func != null){
			SPR_ADV_HIDE.setTransitionCompleteCall(func);
		}else{
			EndLoad();
		}
		return;
	}

	SPR_ADV_HIDE = new LoadProcessScreen(win, win.baseLayer);
	with(SPR_ADV_HIDE){
		.setTransitionCompleteCall(func);

		.opacity = 0;
		.setBlendingEnvelope(255);
		.beginActivation(300);
		.visible = true;
	}
}
function EndLoad(func=null){
	if(SPR_ADV_HIDE == null) return;
	with(SPR_ADV_HIDE){
		//ƒgƒ‰ƒ“ƒWƒbƒVƒ‡ƒ“‚ªI‚í‚Á‚½‚çíœ‚·‚é
		.setTransitionCompleteCall(DestroyLoad, true);

		.setBlendingEnvelope(0);
		.beginActivation(500);
	}
}
function DestroyLoad(){
	if(SPR_ADV_HIDE == null) return;

	invalidate SPR_ADV_HIDE;
	SPR_ADV_HIDE = null;
}
function IsLoadProccesing(){
	return (SPR_ADV_HIDE != null);
}

//-----------------------------------------------
//ƒXƒNƒŠƒvƒg‚Ì•]‰¿®‚Å—˜—p‚·‚éƒRƒ}ƒ“ƒhƒ‰ƒbƒp[
//-----------------------------------------------
function GetParam(id){
	return game.getScene(SCENE_ADV).getParam(id);
}
function SetParam(id, arg){
	return game.getScene(SCENE_ADV).setParam(id, arg);
}
function ChkFlagOn(id){
	return game.getScene(SCENE_ADV).chkFlagOn(id);
}
function ChkFlagOff(id){
	return game.getScene(SCENE_ADV).chkFlagOff(id);
}
function ChkSelect(id){
	if(typeof id == "Integer")
		return game.getScene(SCENE_ADV).chkSelect(id);
	else
		return game.getScene(SCENE_ADV).chkSelectStr(id);
}
function ChkDate(month, day){
	return game.getScene(SCENE_ADV).chkDate(month, day);
}
function IsRecollect(){
	var scene = game.getScene(SCENE_ADV);
	if(scene === void)
		return false;
	else
		return scene.isRecollect();
}
